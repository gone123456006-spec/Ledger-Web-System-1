<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>GST Order</title>

  <style>
    /* =====================================================
   FULLY RESPONSIVE APPLE-STYLE ERP UI ‚Äì ORDERS
===================================================== */

    :root {
      --bg: #f8f9fc;
      --card: #ffffff;
      --text: #1e293b;
      --muted: #64748b;
      --border: #e2e8f0;
      --primary: #3b82f6;
      /* Modern Blue */
      --primary-hover: #2563eb;
      --primary-soft: rgba(59, 130, 246, 0.1);
      --danger: #ef4444;
      --success: #10b981;
      --radius: 12px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.05), 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    }

    /* RESET */
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, Arial, sans-serif;
    }

    /* Hide number input arrows */
    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type=number] {
      -moz-appearance: textfield;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 1400px;
      margin: auto;
      padding: 16px;
    }

    /* =====================
   TITLE
===================== */
    .order-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    /* =====================
   TOP GRID (DESKTOP)
===================== */
    .order-top {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 16px;
      margin-bottom: 18px;
    }

    /* =====================
   CARD / BOX
===================== */
    .box {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      padding: 16px;
      animation: fadeIn .35s ease;
    }

    .box-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--muted);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }

    /* =====================
   FORM
===================== */
    .row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .row label {
      min-width: 110px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 600;
    }

    .row input,
    .row select {
      flex: 1;
      height: 36px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #fff;
      transition: .2s;
    }

    .row input:focus,
    .row select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px var(--primary-soft);
    }

    .row input[readonly] {
      background: #f5f5f7;
    }

    .row button {
      width: 100%;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #eef4ff;
      color: #003a8f;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    .row button:hover {
      background: #dce9ff;
    }

    /* =====================
   HEADER (LEGACY - KEEP FOR COMPATIBILITY)
===================== */
    .header {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 16px;
      margin-bottom: 18px;
    }

    /* =====================
   TABLE (RESPONSIVE)
===================== */
    .order-details {
      margin-top: 18px;
    }

    .table-wrap {
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      overflow-x: auto;
      margin-top: 10px;
    }

    table {
      width: 100%;
      min-width: 1200px;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 13.5px;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #f5f6fa;
      z-index: 2;
    }

    th,
    td {
      border-bottom: 1px solid var(--border);
      padding: 8px 10px;
      white-space: nowrap;
    }

    th {
      background: #f5f6fa;
      font-weight: 600;
    }

    tbody tr:hover {
      background: #f8faff;
    }

    .total {
      background: #fff2cc;
      font-weight: 600;
    }

    table input,
    table select {
      width: 100%;
      height: 30px;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 4px 6px;
    }

    /* =====================
   ACTION BUTTONS
===================== */
    .actions {
      margin-top: 18px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .actions button {
      min-width: 96px;
      height: 38px;
      padding: 6px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: .2s;
    }

    .actions button:hover {
      background: #f5f5f7;
    }

    .actions button:first-child {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
      font-weight: 600;
    }

    .actions button:first-child:hover {
      background: #0056b3;
    }


    /* =====================
   INVOICE
===================== */
    #invoice {
      display: none;
      padding: 20px;
      background: #fff;
      max-width: 210mm;
      margin: 0 auto;
      font-size: 12px;
      overflow-x: hidden;
      box-sizing: border-box;
      word-wrap: break-word;
    }

    #invoice h2 {
      margin: 10px 0 20px 0;
      font-size: 20px;
      border-bottom: 2px solid #333;
      padding-bottom: 10px;
    }

    #invoice table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 11px;
      table-layout: fixed;
      word-wrap: break-word;
    }

    #invoice table th {
      background: #f5f5f5;
      padding: 6px 4px;
      border: 1px solid #ddd;
      text-align: left;
      font-weight: 600;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #invoice table td {
      padding: 5px 4px;
      border: 1px solid #ddd;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
    }

    #invoice .invoice-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
      flex-wrap: wrap;
      gap: 10px;
    }

    #invoice .invoice-header-left,
    #invoice .invoice-header-right {
      flex: 1;
      min-width: 200px;
    }

    #invoice .invoice-header p {
      margin: 3px 0;
      font-size: 11px;
    }

    #invoice .payment-details {
      margin-top: 20px;
      page-break-inside: avoid;
    }

    #invoice .payment-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      table-layout: fixed;
      font-size: 10px;
    }

    #invoice .payment-table th {
      background: #f8f9fa;
      padding: 6px 4px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #invoice .payment-table td {
      padding: 5px 4px;
      border: 1px solid #ddd;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
    }

    #invoice .ratebook-table,
    #invoice .receipt-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      table-layout: fixed;
      font-size: 10px;
    }

    #invoice .ratebook-table th,
    #invoice .receipt-table th {
      background: #f8f9fa;
      padding: 6px 4px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #invoice .ratebook-table td,
    #invoice .receipt-table td {
      padding: 5px 4px;
      border: 1px solid #ddd;
      font-size: 10px;
      overflow: hidden;
      text-overflow: ellipsis;
      word-wrap: break-word;
    }

    #invoice .summary-box {
      margin-top: 15px;
      padding: 12px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      page-break-inside: avoid;
      overflow: hidden;
    }

    #invoice .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 12px;
    }

    #invoice .summary-row:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 13px;
      padding-top: 8px;
    }

    @media print {
      #invoice {
        padding: 10mm;
        max-width: 100%;
        overflow: hidden;
        box-sizing: border-box;
      }

      body {
        background: #fff;
        margin: 0;
        padding: 0;
      }

      .no-print {
        display: none !important;
      }

      #invoice table {
        font-size: 9px;
      }

      #invoice table th,
      #invoice table td {
        padding: 4px 3px;
        font-size: 9px;
      }

      #invoice .invoice-header p {
        font-size: 10px;
      }

      #invoice .summary-row {
        font-size: 11px;
      }

      @page {
        size: A4;
        margin: 10mm;
      }

      * {
        box-sizing: border-box;
      }
    }


    /* =====================
   TABLET (‚â§ 1024px)
===================== */
    @media(max-width:1024px) {
      .order-top {
        grid-template-columns: 1fr;
      }
    }

    /* =====================
   MOBILE (‚â§ 600px)
===================== */
    @media(max-width:600px) {
      .app {
        padding: 12px;
      }

      .order-title {
        font-size: 16px;
      }

      .row {
        flex-direction: column;
        align-items: flex-start;
      }

      .row label {
        min-width: 100%;
      }

      .row input,
      .row select {
        width: 100%;
        height: 40px;
      }
    }

    /* =====================
   ORDER POPUP (NEW)
===================== */
    .popup-bg {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .popup-box {
      background: #fff;
      width: 300px;
      padding: 15px;
      border-radius: 10px;
    }

    .popup-row {
      margin-bottom: 10px;
    }

    .popup-row label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .popup-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .popup-days {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .popup-days input[type="number"] {
      width: 80px;
    }

    .popup-box textarea {
      font-family: inherit;
      resize: vertical;
    }

    /* =====================
   PAYMENT POPUP STYLES
===================== */
    .payment-window {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #d1d6de;
      box-shadow: 0 25px 45px rgba(0, 0, 0, .25);
      max-width: 900px;
      width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
    }

    .payment-title-bar {
      background: linear-gradient(#f4f6fa, #e6eaf0);
      padding: 10px;
      font-weight: 600;
      font-size: 15px;
      text-align: center;
      border-bottom: 1px solid #d1d6de;
      border-radius: 16px 16px 0 0;
    }

    .payment-content {
      display: flex;
      gap: 40px;
      padding: 22px 30px;
      background: #f9fbfe;
    }

    .payment-left,
    .payment-right {
      flex: 1;
    }

    .payment-content h3 {
      margin: 0 0 16px 0;
      font-size: 15px;
    }

    .payment-form-row {
      display: flex;
      align-items: center;
      margin-bottom: 14px;
    }

    .payment-form-row label {
      width: 160px;
      font-size: 14px;
    }

    .payment-form-row input,
    .payment-form-row select,
    .payment-form-row textarea {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d6de;
      font-size: 14px;
    }

    .payment-form-row textarea {
      height: 90px;
      resize: none;
    }

    .payment-form-row input:focus,
    .payment-form-row select:focus,
    .payment-form-row textarea:focus {
      outline: none;
      border-color: #007aff;
      box-shadow: 0 0 0 3px rgba(0, 122, 255, .18);
    }

    .payment-footer {
      display: flex;
      justify-content: center;
      gap: 14px;
      padding: 16px;
      background: #f2f5f9;
      border-top: 1px solid #d1d6de;
      border-radius: 0 0 16px 16px;
    }

    .payment-footer button {
      min-width: 120px;
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 10px;
      border: 1px solid #d1d6de;
      background: #ffffff;
      cursor: pointer;
    }

    @media(max-width:800px) {
      .payment-content {
        flex-direction: column;
      }

      .payment-form-row {
        flex-direction: column;
        align-items: flex-start;
      }

      .payment-form-row label {
        width: 100%;
        margin-bottom: 4px;
      }
    }

    /* =====================
   INFO PANEL (PAYMENT, RATEBOOK, RECEIPT)
===================== */
    .info-panel {
      margin-top: 18px;
      background: var(--card);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      padding: 16px;
      animation: fadeIn .35s ease;
    }

    .panel-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      /* Ensure 2 columns to fill space */
      gap: 20px;
    }

    .panel-section {
      background: #f8f9fa;
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .panel-section-header {
      background: #fff;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }

    .panel-section-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .panel-add-btn {
      padding: 4px 10px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--primary);
      cursor: pointer;
      font-weight: 500;
      transition: .2s;
    }

    .panel-add-btn:hover {
      background: var(--primary-soft);
    }

    .panel-content {
      padding: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .panel-summary {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .summary-item:last-child {
      margin-bottom: 0;
    }

    .summary-label {
      color: var(--muted);
      font-weight: 500;
    }

    .summary-value {
      font-weight: 600;
      color: var(--text);
    }

    .summary-value.paid {
      color: #28a745;
    }

    .summary-value.balance {
      color: #dc3545;
    }

    .panel-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .panel-item {
      background: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
    }

    .panel-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-weight: 600;
      gap: 8px;
    }

    .panel-item-detail {
      color: var(--muted);
      font-size: 11px;
      margin-top: 2px;
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      font-size: 12px;
      padding: 20px 0;
    }

    @media(max-width:1024px) {
      .panel-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <div class="app no-print" id="orderApp">

    <div class="order-title">GST Order</div>

    <!-- TOP -->
    <div class="order-top">

      <!-- CUSTOMER -->
      <div class="box">
        <div class="box-title">Customer Information</div>

        <div class="row">
          <label>Name *</label>
          <select id="custName"></select>
        </div>

        <div class="row">
          <label>Current Bal</label>
          <input id="currentBal" readonly>
        </div>

        <div class="row">
          <label>Relation</label>
          <input id="relation" readonly>
        </div>

        <div class="row">
          <label>Station</label>
          <input id="station" readonly>
        </div>

        <div class="row">
          <button onclick="openCustomer()" class="no-print">
            + Add / Edit Customer
          </button>
        </div>
      </div>

      <!-- BILL -->
      <div class="box">
        <div class="box-title">Bill Information</div>

        <div class="row">
          <label>Bill No</label>
          <input id="billNo">
        </div>

        <div class="row">
          <label>Date</label>
          <input type="date" id="orderDate">
        </div>
        <div class="row">
          <label>Due Date</label>
          <input type="date" id="dueDate">
        </div>

        <div class="row">
          <label>GST %</label>
          <input id="gstRate">
        </div>
      </div>

    </div>

    <!-- DETAILS -->
    <div class="order-details">
      <div class="box-title">Order Details</div>

      <div class="table-wrap">
        <table id="itemTable">
          <thead>
            <tr>
              <th style="min-width: 100px;">Type</th>
              <th>Bill No.</th>
              <th>Item Name</th>
              <th>Stamp</th>
              <th>Remarks</th>
              <th>Design</th>
              <th>Size</th>
              <th>Pc</th>
              <th>Ut. Wt.</th>
              <th>Est. Total Wt.</th>
              <th>Rate</th>
              <th>Lbr.%</th>
              <th class="total">Total</th>
              <th>‚ùå</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="actions">
      <button onclick="addRow()"> Add Row</button>

      <button onclick="openPayment()"> Payment</button>
      <button onclick="openRateBook()"> Rate Book</button>
      <button onclick="saveOrder()"> Save</button>
      <button onclick="saveAndNew()"> Save & New</button>
      <button onclick="resetOrder()"> Reset</button>
      <button onclick="showInvoice()"> A4 Invoice</button>
      <button onclick="closeDashboard()" style="background:#dc3545; border-color:#dc3545; color:white;"> Close</button>
    </div>

    <!-- PAYMENT, RATEBOOK & RECEIPT PANEL -->
    <div class="info-panel">
      <div class="panel-grid">
        <!-- RATEBOOK SECTION -->
        <div class="panel-section">
          <div class="panel-section-header">
            <h3>Ratebook</h3>
            <button class="panel-add-btn" onclick="openRateBook()">+ Add</button>
          </div>
          <div class="panel-content" id="ratebookPanelContent">
            <div class="panel-list" id="ratebookList">
              <div class="empty-state">No rates available</div>
            </div>
          </div>
        </div>

        <!-- PAYMENT SECTION -->
        <div class="panel-section">
          <div class="panel-section-header">
            <h3>Payment</h3>
            <button class="panel-add-btn" onclick="openPayment()">+ Add</button>
          </div>
          <div class="panel-content" id="paymentPanelContent">
            <div class="panel-summary">
              <div class="summary-item">
                <span class="summary-label">Order Total:</span>
                <span class="summary-value" id="panelOrderTotal">‚Çπ 0.00</span>
              </div>
              <div class="summary-item" style="color:#d63384;">
                <span class="summary-label">Purchase Total:</span>
                <span class="summary-value" id="panelPurchaseTotal">‚Çπ 0.00</span>
              </div>
              <div class="summary-item" style="border-top:1px dashed #ccc; padding-top:4px; margin-top:4px;">
                <span class="summary-label">Net Bill Total:</span>
                <span class="summary-value" id="panelBillTotal">‚Çπ 0.00</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Paid:</span>
                <span class="summary-value paid" id="panelPaid">‚Çπ 0.00</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Balance:</span>
                <span class="summary-value balance" id="panelBalance">‚Çπ 0.00</span>
              </div>
            </div>
            <div class="panel-list" id="paymentList">
              <div class="empty-state">No payments yet</div>
            </div>
          </div>
        </div>
      </div>
    </div>







  </div>

  <!-- INVOICE -->
  <div id="invoice">
    <div class="no-print" style="margin-bottom:15px;">
      <button onclick="back()" style="padding:8px 15px; margin-right:10px; cursor:pointer;">‚Üê Back</button>
      <button onclick="window.print()" style="padding:8px 15px; cursor:pointer;">üñ®Ô∏è Print</button>
    </div>

    <h2 style="text-align:center">GST TAX INVOICE</h2>

    <div class="invoice-header">
      <div class="invoice-header-left">
        <p style="margin:5px 0;"><strong>Customer:</strong> <span id="iCustomer"></span></p>
        <p style="margin:5px 0;"><strong>Order Date:</strong> <span id="iOrderDate"></span></p>
        <p style="margin:5px 0;"><strong>Bill No:</strong> <span id="iBillNo"></span></p>
      </div>
      <div class="invoice-header-right" style="text-align:right;">
        <p style="margin:5px 0;"><strong>Invoice Date:</strong> <span id="iInvoiceDate"></span></p>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:25%;">Item</th>
          <th style="width:8%;">Pc</th>
          <th style="width:10%;">Net Wt</th>
          <th style="width:10%;">Rate</th>
          <th style="width:12%;">Total</th>
          <th style="width:35%;">Order Details</th>
        </tr>
      </thead>
      <tbody id="iItems"></tbody>
    </table>

    <div class="summary-box">
      <div class="summary-row">
        <span><strong>Grand Total:</strong></span>
        <span><strong>‚Çπ <span id="iGrand">0.00</span></strong></span>
      </div>
      <div class="summary-row" style="color:#28a745;">
        <span><strong>Paid Amount:</strong></span>
        <span><strong>‚Çπ <span id="iPaid">0.00</span></strong></span>
      </div>
      <div class="summary-row" style="color:#dc3545;">
        <span><strong>Balance Amount:</strong></span>
        <span><strong>‚Çπ <span id="iBalance">0.00</span></strong></span>
      </div>
      <div class="summary-row" style="color:#0d6efd;">
        <span><strong>Ratebook Total:</strong></span>
        <span><strong>‚Çπ <span id="iRatebookTotal">0.00</span></strong></span>
      </div>
      <div class="summary-row" id="iRateDiffRow">
        <span><strong>Difference (Bill - Ratebook):</strong></span>
        <span><strong><span id="iRateDiffSign">+</span> ‚Çπ <span id="iRateDiff">0.00</span></strong></span>
      </div>
      <div class="summary-row" style="color:#6f42c1;">
        <span><strong>Ratebook Rate:</strong></span>
        <span><strong>‚Çπ <span id="iRbRate">0.00</span></strong></span>
      </div>
      <div class="summary-row" style="color:#6f42c1;">
        <span><strong>Old Weight:</strong></span>
        <span><strong><span id="iRbOldWt">0.000</span></strong></span>
      </div>
      <div class="summary-row" style="color:#6f42c1;">
        <span><strong>Current Weight:</strong></span>
        <span><strong><span id="iRbCurWt">0.000</span></strong></span>
      </div>
      <div class="summary-row" style="color:#6f42c1;">
        <span><strong>Weight Difference:</strong></span>
        <span><strong><span id="iRbWtSign">‚àí</span> <span id="iRbWtDiff">0.000</span></strong></span>
      </div>
      <div class="summary-row" style="color:#6f42c1;">
        <span><strong>Weight Amount:</strong></span>
        <span><strong>‚Çπ <span id="iRbWtAmt">0.00</span></strong></span>
      </div>
    </div>

    <!-- PAYMENT TABLE -->
    <div id="paymentDetails" class="payment-details">
      <h3
        style="margin-top:25px; margin-bottom:10px; font-size:14px; border-bottom:1px solid #ddd; padding-bottom:5px;">
        Payment Details</h3>
      <table class="payment-table" id="invoicePaymentTable">
        <thead>
          <tr>
            <th style="width:12%;">Date</th>
            <th style="width:12%;">Amount</th>
            <th style="width:12%;">Mode</th>
            <th style="width:12%;">Batch</th>
            <th style="width:12%;">Type</th>
            <th style="width:40%;">Narration</th>
          </tr>
        </thead>
        <tbody id="invoicePaymentBody"></tbody>
      </table>
    </div>

    <!-- RATEBOOK TABLE -->
    <div id="ratebookDetails" class="ratebook-details">
      <h3
        style="margin-top:25px; margin-bottom:10px; font-size:14px; border-bottom:1px solid #ddd; padding-bottom:5px;">
        Ratebook Details</h3>
      <table class="ratebook-table" id="invoiceRatebookTable">
        <thead>
          <tr>
            <th style="width:15%;">Date</th>
            <th style="width:15%;">Item Name</th>
            <th style="width:12%;">Stamp</th>
            <th style="width:12%;">Weight</th>
            <th style="width:12%;">Rate</th>
            <th style="width:12%;">Amount</th>
            <th style="width:22%;">Narration</th>
          </tr>
        </thead>
        <tbody id="invoiceRatebookBody"></tbody>
      </table>
    </div>

    <!-- RECEIPT TABLE -->
    <div id="receiptDetails" class="receipt-details">
      <h3
        style="margin-top:25px; margin-bottom:10px; font-size:14px; border-bottom:1px solid #ddd; padding-bottom:5px;">
        Receipt Details</h3>
      <table class="receipt-table" id="invoiceReceiptTable">
        <thead>
          <tr>
            <th style="width:10%;">Date</th>
            <th style="width:10%;">Bill No</th>
            <th style="width:10%;">Amount</th>
            <th style="width:10%;">Mode</th>
            <th style="width:10%;">Type</th>
            <th style="width:35%;">Narration</th>
            <th style="width:5%;">Action</th>
          </tr>
        </thead>
        <tbody id="invoiceReceiptBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ORDER POPUP -->
  <div id="orderPopup" class="popup-bg" onclick="if(event.target===this) closePopup()">
    <div class="popup-box">
      <h3>Order Details</h3>
      <div class="popup-row">
        <label>Days</label>
        <input type="number" id="popupDays" min="1" placeholder="Enter days" oninput="calculateDeliveryDate()">
        <button onclick="calculateDeliveryDate()" style="padding:6px 12px; height:30px;">Apply</button>
      </div>
      <div class="popup-row">
        <label>Delivery Date</label>
        <input type="date" id="popupDelivery">
      </div>
      <div class="popup-row">
        <label>Sample Details</label>
        <input id="popupSample">
      </div>
      <div class="popup-actions">
        <button onclick="saveOrderPopup()">Save</button>
        <button onclick="closePopup()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- PAYMENT POPUP (from payment.html) -->
  <div id="paymentPopup" class="popup-bg" onclick="if(event.target===this) closePaymentPopup()">
    <div class="payment-window">
      <div class="payment-title-bar">RECEIPT / PAYMENT</div>
      <div class="payment-content">
        <!-- LEFT -->
        <div class="payment-left">
          <h3>Payment Details</h3>
          <div class="payment-form-row">
            <label>Payment Mode</label>
            <select id="mode">
              <option>Cash</option>
              <option>Card</option>
              <option>Cheque</option>
              <option>UPI</option>
              <option>Online</option>
            </select>
          </div>
          <div class="payment-form-row">
            <label>Amount</label>
            <input type="number" id="amount" placeholder="" step="" min="" oninput="calculatePaymentBalance()">
          </div>
          <div class="payment-form-row" style="margin-top:15px; padding-top:15px; border-top:1px solid #d1d6de;">
            <div style="width:100%;">
              <div style="margin-bottom:8px;">
                <strong>Bill Total: ‚Çπ<span id="paymentBillTotal">0.00</span></strong>
              </div>
              <div style="margin-bottom:8px;">
                <strong>Amount: ‚Çπ<span id="paymentAmountDisplay">0.00</span></strong>
              </div>
              <div>
                <strong style="color:#dc3545;">Balance: ‚Çπ<span id="paymentBalance">0.00</span></strong>
              </div>
            </div>
          </div>
        </div>
        <!-- RIGHT -->
        <div class="payment-right">
          <h3>Additional Info</h3>
          <div class="payment-form-row">
            <label>Narration</label>
            <textarea id="narration"></textarea>
          </div>
          <div class="payment-form-row">
            <label>Batch</label>
            <input id="batch">
          </div>
          <div class="payment-form-row">
            <label>Type</label>
            <input id="type">
          </div>
          <div class="payment-form-row">
            <label>Exp Date</label>
            <input id="expDate" placeholder="MM/YY">
          </div>
          <div class="payment-form-row">
            <label>Ap.Code</label>
            <input id="apCode">
          </div>
          <div class="payment-form-row">
            <label></label>
            <div>
              <label><input type="radio" name="ptype" value="Cash" checked> Cash</label>
              &nbsp;&nbsp;
              <label><input type="radio" name="ptype" value="Chq"> Chq</label>
            </div>
          </div>
        </div>
      </div>
      <div class="payment-footer">
        <button onclick="savePaymentFromPopup()">Save</button>
        <button onclick="closePaymentPopup()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    /* =====================
       DOM REFERENCES
    ===================== */
    let custName = null;
    let currentBal = null;
    let relation = null;
    let station = null;
    let orderDate = null;
    let dueDate = null;
    let billNo = null;
    let gstRate = null;
    let itemBody = null;
    let orderApp = null;
    let invoice = null;
    let orderPopup = null;
    let popupDelivery = null;
    let popupSample = null;
    let popupDays = null;
    let paymentPopup = null;
    let paymentBillTotal = null;
    let paymentAmountDisplay = null;
    let paymentBalance = null;

    // Invoice elements
    let iCustomer = null;
    let iOrderDate = null;
    let iBillNo = null;
    let iItems = null;
    let iGrand = null;

    let activeRow = null;

    /* =====================
       INITIALIZE ELEMENTS
    ===================== */
    function initElements() {
      // Try to find elements in workspace first (dashboard context)
      const workspace = document.querySelector(".workspace");
      const searchRoot = workspace || document;

      custName = searchRoot.querySelector("#custName") || document.getElementById("custName");
      currentBal = searchRoot.querySelector("#currentBal") || document.getElementById("currentBal");
      relation = searchRoot.querySelector("#relation") || document.getElementById("relation");
      station = searchRoot.querySelector("#station") || document.getElementById("station");
      orderDate = searchRoot.querySelector("#orderDate") || document.getElementById("orderDate");
      dueDate = searchRoot.querySelector("#dueDate") || document.getElementById("dueDate");
      billNo = searchRoot.querySelector("#billNo") || document.getElementById("billNo");
      gstRate = searchRoot.querySelector("#gstRate") || document.getElementById("gstRate");
      itemBody = searchRoot.querySelector("#itemTable tbody") || document.querySelector("#itemTable tbody");
      orderApp = searchRoot.querySelector("#orderApp") || document.getElementById("orderApp");
      invoice = searchRoot.querySelector("#invoice") || document.getElementById("invoice");
      orderPopup = searchRoot.querySelector("#orderPopup") || document.getElementById("orderPopup");
      popupDelivery = searchRoot.querySelector("#popupDelivery") || document.getElementById("popupDelivery");
      popupSample = searchRoot.querySelector("#popupSample") || document.getElementById("popupSample");
      popupDays = searchRoot.querySelector("#popupDays") || document.getElementById("popupDays");
      paymentPopup = searchRoot.querySelector("#paymentPopup") || document.getElementById("paymentPopup");
      paymentBillTotal = searchRoot.querySelector("#paymentBillTotal") || document.getElementById("paymentBillTotal");
      paymentAmountDisplay = searchRoot.querySelector("#paymentAmountDisplay") || document.getElementById("paymentAmountDisplay");
      paymentBalance = searchRoot.querySelector("#paymentBalance") || document.getElementById("paymentBalance");

      // Invoice elements
      iCustomer = searchRoot.querySelector("#iCustomer") || document.getElementById("iCustomer");
      iOrderDate = searchRoot.querySelector("#iOrderDate") || document.getElementById("iOrderDate");
      iBillNo = searchRoot.querySelector("#iBillNo") || document.getElementById("iBillNo");
      iItems = searchRoot.querySelector("#iItems") || document.getElementById("iItems");
      iGrand = searchRoot.querySelector("#iGrand") || document.getElementById("iGrand");

      // Check if required elements exist
      if (!custName || !orderDate || !billNo || !itemBody) {
        return false;
      }

      return true;
    }

    /* INIT */
    function initOrderPage() {
      // Wait for elements to be ready
      if (!initElements()) {
        // Retry after a short delay
        setTimeout(initOrderPage, 100);
        return;
      }

      // Initialize date and bill number
      // IMPORTANT: If we are returning from Ratebook/Receipt (workspace navigation),
      // do NOT generate new Bill No / Date ‚Äî restoreOrderState will restore them.
      const savedStateAtInit = localStorage.getItem("newOrderState");
      // If saved state exists (Ratebook/Receipt flow), do not generate new values.
      if (!savedStateAtInit) {
        if (orderDate && !orderDate.value) {
          orderDate.valueAsDate = new Date();
        }
        if (billNo && !billNo.value) {
          billNo.value = generateBillNo();
        }
      }

      // Load customers
      loadCustomers();

      // Set up billNo change handler (avoid duplicate listeners)
      if (billNo) {
        billNo.oninput = function () {
          // Update all job numbers in existing rows
          if (itemBody) {
            itemBody.querySelectorAll("tr").forEach(tr => {
              if (tr.cells[1] && tr.cells[1].children[0]) {
                tr.cells[1].children[0].value = billNo.value;
              }
            });
          }
          // Refresh panels for the current bill no
          updateInfoPanel();
        };
      }

      // If we have a saved state (Ratebook/Receipt flow), restore it first.
      // This prevents Customer/Bill/Payment info from getting cleared when returning.
      const savedState = localStorage.getItem("newOrderState");
      if (savedState) {
        setTimeout(() => {
          restoreOrderState();
        }, 200);
      } else {
        // Check if editing an existing order
        const editOrderId = localStorage.getItem("editOrderId");
        if (editOrderId) {
          // Wait a bit for DOM to be ready, then load order
          setTimeout(() => {
            loadOrderForEdit(editOrderId);
          }, 200);
        } else {
          // Check if there's a selected customer from customer page
          const selectedCustomer = localStorage.getItem("selectedCustomerName");
          if (selectedCustomer && custName) {
            // Try to find and select the customer
            const options = Array.from(custName.options);
            const option = options.find(opt => opt.textContent === selectedCustomer);
            if (option) {
              custName.value = option.value;
              custName.dispatchEvent(new Event('change'));
            }
            localStorage.removeItem("selectedCustomerName");
          }

          // Only add row if we don't have existing data
          if (itemBody && itemBody.querySelectorAll("tr").length === 0) {
            addRow();
          }
        }
      }

      // Ensure functions are globally accessible
      ensureFunctionsGlobal();

      // NOTE: Return-from-Ratebook/Receipt restoration is handled by `restoreOrderState()`.
      // Do not clear `ratebookOpened` / `receiptOpened` here; we clear them AFTER restoring
      // so Bill No / Customer / Paid amount don't get reset.

      // Initialize panel
      updateInfoPanel();

      // Global event listeners (attach once; initOrderPage can run multiple times)
      if (!window.__newOrderGlobalListenersAttached) {
        window.__newOrderGlobalListenersAttached = true;

        // Listen for payment saved event
        window.addEventListener('paymentSaved', function () {
          updateInfoPanel();
        });

        // Listen for receipt saved event
        window.addEventListener('receiptSaved', function () {
          // Force update receipt panel immediately to show newly saved receipt
          setTimeout(() => {
            updateReceiptPanel();
            updateInfoPanel();
          }, 50);
          // If invoice is currently displayed, refresh the receipt table
          if (invoice && invoice.style.display !== 'none') {
            // Refresh receipt table in invoice
            setTimeout(() => {
              refreshInvoiceReceiptTable();
            }, 100);
          }
        });

        // Listen for rate saved event
        window.addEventListener('rateSaved', function () {
          updateInfoPanel();
        });

        // Listen for storage changes (when ratebook, payments, or receipts are updated from other windows)
        window.addEventListener('storage', function (e) {
          if (e.key === 'payments' || e.key === 'rateBook' || e.key === 'bills' || e.key === 'receipts') {
            // Force update all panels, especially receipt panel
            setTimeout(() => {
              updateReceiptPanel();
              updateInfoPanel();
            }, 100);
          }
          // If ratebook was closed and we have saved state, restore it
          if (e.key === 'newOrderState' && e.newValue) {
            setTimeout(() => {
              restoreOrderState();
            }, 200);
          }
        });

        // Also listen for custom events from ratebook page
        window.addEventListener('ratebookUpdated', function () {
          updateInfoPanel();
        });

        // Listen for page visibility change (when returning from ratebook or receipt)
        document.addEventListener('visibilitychange', function () {
          if (!document.hidden) {
            // Page became visible - refresh panels to show latest data
            setTimeout(() => {
              updateInfoPanel();
              updateReceiptPanel();
            }, 200);
            // Check if we need to restore state
            const savedState = localStorage.getItem("newOrderState");
            if (savedState) {
              setTimeout(() => {
                restoreOrderState();
              }, 300);
            }
          }
        });

        // Listen for focus event (when window regains focus after ratebook/receipt closes)
        window.addEventListener('focus', function () {
          // Refresh panels to show latest data
          setTimeout(() => {
            updateInfoPanel();
            updateReceiptPanel();
          }, 100);
          const savedState = localStorage.getItem("newOrderState");
          if (savedState) {
            setTimeout(() => {
              restoreOrderState();
            }, 200);
          }
        });
      }
    }

    // Check if we're in workspace context
    function isInWorkspace() {
      return !!document.querySelector(".workspace");
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function () {
        // If in workspace, wait a bit longer for content to be inserted
        if (isInWorkspace()) {
          setTimeout(initOrderPage, 200);
        } else {
          initOrderPage();
        }
      });
    } else {
      // DOM already ready, but might be in workspace
      if (isInWorkspace()) {
        // In workspace, wait for content to be inserted
        setTimeout(initOrderPage, 200);
      } else {
        setTimeout(initOrderPage, 50);
      }
    }

    // Listen for page refresh event from dashboard
    window.addEventListener('pageRefresh', function () {
      setTimeout(initOrderPage, 150);
    });

    // Also listen on workspace if it exists
    const workspace = document.querySelector(".workspace");
    if (workspace) {
      workspace.addEventListener('pageRefresh', function () {
        setTimeout(initOrderPage, 150);
      });
    }

    // BillNo change listener is now set up in initOrderPage()

    /* AUTO BILL NO */
    function generateBillNo() {
      let last = localStorage.getItem("lastBillNo") || "0";
      let next = Number(last) + 1;
      localStorage.setItem("lastBillNo", next);
      return "B-" + String(next).padStart(4, "0");
    }

    /* AUTO JOB NO - Same as Order No */
    function generateJobNo() {
      // Use the same bill number as order number
      return billNo.value || generateBillNo();
    }

    /* CUSTOMER */
    function loadCustomers() {
      if (!custName) return;

      const list = JSON.parse(localStorage.getItem("customers") || "[]");
      custName.innerHTML = `<option value="">-- Select --</option>`;
      list.forEach(c => {
        const o = document.createElement("option");
        o.value = c.id;
        o.textContent = c.name;
        o.dataset.data = JSON.stringify(c);
        custName.appendChild(o);
      });

      // Set up change handler
      custName.onchange = function () {
        if (!custName) return;
        const o = custName.selectedOptions[0];
        if (!o || !o.dataset.data) return;
        const c = JSON.parse(o.dataset.data);
        if (currentBal) currentBal.value = c.openingBalance || 0;
        if (relation) relation.value = (c.relation || "") + " " + (c.relationName || "");
        if (station) station.value = c.station || "";
        // Keep panels in sync with customer selection
        updateInfoPanel();
      };
    }

    function openCustomer() {
      if (typeof loadPage === 'function') {
        loadPage("pages/customer.html");
      } else {
        window.open("/pages/customer.html", "Customer", "width=1200,height=700");
      }
    }

    function setCustomerName(name) {
      if (!custName) return;

      // Find customer by name and select it
      const options = custName.options;
      for (let i = 0; i < options.length; i++) {
        if (options[i].textContent === name) {
          custName.value = options[i].value;
          custName.dispatchEvent(new Event('change'));
          break;
        }
      }
    }

    function getCustomerName() {
      if (!custName) return "";
      const selected = custName.selectedOptions[0];
      return selected ? selected.textContent : "";
    }

    /* ADD ROW */
    function addRow() {
      if (!itemBody) {
        if (!initElements()) return;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
<td>
  <select onchange="handleTypeChange(this)">
    <option>Order</option>
    <option>Repair</option>
    <option>Sale</option>
    <option>Purchase</option>
  </select>
</td>
<td><input readonly></td>
<td><input placeholder="Item Name"></td>
<td><input placeholder="Stamp"></td>
<td><input placeholder="Remarks"></td>
<td><input placeholder="Design"></td>
<td><input placeholder="Size"></td>
<td><input type="number" step="0.01" placeholder="0" oninput="calc(this)" onchange="calc(this)"></td>
<td><input type="number" step="0.01" placeholder="0" oninput="calc(this)" onchange="calc(this)"></td>
<td><input type="number" step="0.01" placeholder="0" oninput="calc(this)" onchange="calc(this)"></td>
<td><input type="number" step="0.01" placeholder="0" oninput="calc(this)" onchange="calc(this)"></td>
<td><input type="number" step="0.01" placeholder="0" oninput="calc(this)" onchange="calc(this)"></td>
<td class="total"><input type="number" step="0.01" readonly placeholder="0.00"></td>
<td><button onclick="this.closest('tr').remove()">X</button></td>
`;
      itemBody.appendChild(tr);
      // Set Job No same as Order No (Bill No)
      if (billNo && tr.cells[1] && tr.cells[1].children[0]) {
        tr.cells[1].children[0].value = billNo.value || generateBillNo();
      }

      // Add event listener for row removal
      const removeBtn = tr.querySelector('button');
      if (removeBtn) {
        removeBtn.addEventListener('click', function () {
          // Update ratebook panel when row is removed
          setTimeout(() => {
            updateRatebookPanel();
          }, 100);
        });
      }

      // Auto-calculate on initial add
      setTimeout(() => {
        if (tr.cells[7] && tr.cells[7].children[0]) {
          calc(tr.cells[7].children[0]);
        }
        updateInfoPanel();
      }, 10);
    }

    /* TYPE ‚Üí POPUP */
    function handleTypeChange(sel) {
      if (!orderPopup || !popupDelivery || !popupSample || !popupDays) {
        if (!initElements()) return;
      }

      const row = sel.closest("tr");
      // Trigger for Order, Repair, Sale, Purchase
      const allowedTypes = ["Order", "Repair", "Sale", "Purchase"];

      if (allowedTypes.includes(sel.value)) {
        activeRow = row;

        // Pre-fill with existing values if available
        if (row.dataset.delivery) {
          popupDelivery.value = row.dataset.delivery;
        } else {
          popupDelivery.value = "";
        }

        if (row.dataset.sample) {
          popupSample.value = row.dataset.sample;
        } else {
          popupSample.value = "";
        }

        if (popupDays) popupDays.value = "";

        if (orderPopup) orderPopup.style.display = "flex";
      }

      // Update totals immediately when type changes (to handle Purchase subtraction)
      updateInfoPanel();
    }

    /* CALCULATE DELIVERY DATE FROM DAYS */
    function calculateDeliveryDate() {
      if (!popupDays || !popupDelivery || !orderDate) {
        if (!initElements()) return;
      }

      const days = parseInt(popupDays.value);
      if (days && days > 0 && orderDate.value) {
        const orderDateObj = new Date(orderDate.value);
        const deliveryDate = new Date(orderDateObj);
        deliveryDate.setDate(deliveryDate.getDate() + days);
        if (popupDelivery) popupDelivery.value = deliveryDate.toISOString().split('T')[0];
      }
    }
    function saveOrderPopup() {
      if (!popupDelivery) {
        if (!initElements()) return;
      }

      if (!popupDelivery.value) {
        alert("Select delivery date");
        return;
      }
      if (activeRow) {
        activeRow.dataset.delivery = popupDelivery.value;
        if (popupSample) activeRow.dataset.sample = popupSample.value;
        activeRow.dataset.orderFilled = "1";
      }
      closePopup();
    }
    function closePopup() {
      if (!orderPopup) {
        if (!initElements()) return;
      }
      if (orderPopup) orderPopup.style.display = "none";
      activeRow = null;
      if (popupDays) popupDays.value = "";
    }

    /* CALCULATION - AUTO CALCULATE ALL FIELDS */
    /* CALCULATION - AUTO CALCULATE ALL FIELDS */
    function calc(el) {
      if (!el || !el.closest) return;

      const r = el.closest("tr");
      if (!r || !r.cells) return;

      try {
        // Get input values
        // Note: Indices shifted due to removal of Less column
        const pc = parseFloat(r.cells[7].children[0].value) || 0;
        const utWt = parseFloat(r.cells[8].children[0].value) || 0; // Ut. Wt.

        // Calculate Est. Total Wt. = Pc * Ut. Wt.
        const estTotalWt = pc * utWt;

        // Always update the Est. Total Wt. input (Cell 9)
        if (r.cells[9] && r.cells[9].children[0]) {
          r.cells[9].children[0].value = estTotalWt.toFixed(3); // 3 decimal places for weight
        }

        // If calculation wasn't performed (e.g. cleared inputs), read the value from input (allow manual)
        // OR strictly enforce. Let's read the value from cell 9 for the cost calculation.
        // This allows manual override if someone types in cell 9 directly (though calc(this) on cell 9 will just re-read it).

        const net = parseFloat(r.cells[9].children[0].value) || 0; // Est. Total Wt
        const rate = parseFloat(r.cells[10].children[0].value) || 0; // Was 11
        const lbr = parseFloat(r.cells[11].children[0].value) || 0; // Was 12

        // AUTO CALCULATE Total = (Net.Wt * Rate) + (Net.Wt * Rate * Lbr% / 100)
        let total = 0;
        if (net > 0 && rate > 0) {
          const base = net * rate;
          const labor = base * (lbr / 100);
          total = base + labor;
          if (r.cells[12] && r.cells[12].children[0]) { // Was 13
            r.cells[12].children[0].value = total.toFixed(2);
          }
        } else {
          // Clear total if no valid calculation
          if (r.cells[12] && r.cells[12].children[0]) { // Was 13
            r.cells[12].children[0].value = "0.00";
          }
        }

      } catch (e) {
        console.error("Error in calc function:", e);
      }

      // Update panel after calculation
      setTimeout(() => {
        updateInfoPanel();
      }, 100);
    }

    /* CALCULATE BILL TOTAL */
    function calculateBillTotal() {
      if (!itemBody) return 0;

      let total = 0;
      itemBody.querySelectorAll("tr").forEach(r => {
        if (r.cells[12] && r.cells[12].children[0]) { // Was 13
          const t = parseFloat(r.cells[12].children[0].value) || 0;
          // Check Type (Column 0)
          const typeSelect = r.cells[0] && r.cells[0].querySelector("select");
          const type = typeSelect ? typeSelect.value : "Order";

          // Order, Repair, Sale = Positive
          // Purchase = Negative (Deducted)
          if (type === "Purchase") {
            total -= t;
          } else {
            total += t;
          }
        }
      });
      return total;
    }

    /* GET PAID AMOUNT FOR BILL */
    function getPaidAmount(billNo) {
      const payments = JSON.parse(localStorage.getItem("payments") || "[]");
      return payments
        .filter(p => p.billNo === billNo)
        .reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
    }

    /* =========================
       RATEBOOK WEIGHT BALANCE (Customer)
       Weight is adjusted on Order/Delivery saves.
    ========================= */
    const RATEBOOK_CUSTOMER_BALANCES_KEY = "rateBookCustomerBalances";

    function rbSafeNum(v, fb = 0) {
      const n = Number(v);
      return Number.isFinite(n) ? n : fb;
    }

    function rbReadBalances() {
      try { return JSON.parse(localStorage.getItem(RATEBOOK_CUSTOMER_BALANCES_KEY) || "{}") || {}; } catch (e) { return {}; }
    }

    function rbWriteBalances(balances) {
      try { localStorage.setItem(RATEBOOK_CUSTOMER_BALANCES_KEY, JSON.stringify(balances || {})); } catch (e) { }
    }

    function rbGetCustomerRecord(customerId, customerName = "") {
      const balances = rbReadBalances();
      const r = balances[customerId] || {};
      return {
        balances, record: {
          customerId,
          customer: customerName || r.customer || "",
          rate: rbSafeNum(r.rate, 0),
          bookedWeight: rbSafeNum(r.bookedWeight, 0),
          currentWeight: rbSafeNum(r.currentWeight, 0),
          updatedAt: r.updatedAt || ""
        }
      };
    }

    function rbSumOrderNetWeight(rows) {
      // new-order.html Net.Wt is column index 10
      return (rows || []).reduce((sum, row) => sum + rbSafeNum(row && row.values ? row.values[10] : 0, 0), 0);
    }

    /* SAVE ORDER */
    function saveOrder(resetAfterSave = false) {
      if (!custName || !billNo || !itemBody) {
        if (!initElements()) {
          alert("Form not initialized. Please refresh the page.");
          return;
        }
      }

      if (!custName.value) { alert("Select customer"); return; }
      if (!billNo.value) { alert("Bill number is required"); return; }

      const billTotal = calculateBillTotal();
      const rows = [...itemBody.querySelectorAll("tr")].map(tr => {
        const type = tr.cells[0].children[0].value;
        return {
          values: [...tr.querySelectorAll("input,select")].map(el => el.value),
          type: type,
          delivery: tr.dataset.delivery || "",
          sample: tr.dataset.sample || "",
          orderFilled: tr.dataset.orderFilled || ""
        };
      });

      if (rows.length === 0) {
        alert("Add at least one item");
        return;
      }

      // Save to bills (for invoice/payment)
      const bills = JSON.parse(localStorage.getItem("bills") || "[]");
      const existingBillIndex = bills.findIndex(b => b.billNo === billNo.value);
      const billData = {
        date: orderDate.value,
        billNo: billNo.value,
        customer: getCustomerName(),
        customerId: custName.value,
        totalAmount: billTotal,
        rows
      };

      if (existingBillIndex >= 0) {
        bills[existingBillIndex] = billData;
      } else {
        bills.push(billData);
      }
      localStorage.setItem("bills", JSON.stringify(bills));

      // Save to orders (for orders.html table)
      const orders = JSON.parse(localStorage.getItem("orders") || "[]");
      const existingOrderIndex = orders.findIndex(o => o.orderNo === billNo.value);

      // Check if we're editing an existing order (by ID)
      const editOrderId = localStorage.getItem("editOrderId");
      let existingOrder = null;
      let existingOrderByIdIndex = -1;

      if (editOrderId) {
        // Try to find by ID - handle both string and number comparisons
        const orderIdNum = Number(editOrderId);
        existingOrderByIdIndex = orders.findIndex(o => {
          return o.id === orderIdNum || o.id === editOrderId || String(o.id) === String(editOrderId);
        });
        if (existingOrderByIdIndex >= 0) {
          existingOrder = orders[existingOrderByIdIndex];
        }
      }
      // Fallback: find existing order by orderNo (idempotent saves)
      if (!existingOrder && existingOrderIndex >= 0) {
        existingOrder = orders[existingOrderIndex];
      }

      // ===== Ratebook Weight Adjustment (when customer takes a new order) =====
      let rbRate = 0;
      let rbOldWeight = 0;
      let rbCurWeight = 0;
      let rbWtDiff = 0;
      let rbWtAmount = 0;
      const orderedNetWt = rbSumOrderNetWeight(rows);
      try {
        const customerId = custName && custName.value ? custName.value : "";
        if (customerId) {
          const { balances, record } = rbGetCustomerRecord(customerId, getCustomerName());
          rbRate = record.rate;
          rbOldWeight = record.currentWeight;

          const prevOrdered = rbSafeNum(existingOrder && existingOrder.ratebookOrderedWeight, 0);
          const prevDelivered = rbSafeNum(existingOrder && existingOrder.ratebookDeliveredWeight, 0);

          // If delivery is already recorded, delivered weight becomes authoritative.
          // In that case, do not alter the customer's balance from the ordered weight here.
          if (prevDelivered > 0) {
            rbCurWeight = rbOldWeight;
          } else {
            // Adjust balance to reflect latest ordered net weight.
            // Delta = prevOrdered - newOrdered (so resaves are idempotent).
            rbCurWeight = rbOldWeight + (prevOrdered - orderedNetWt);
            balances[customerId] = {
              ...record,
              rate: rbRate,
              currentWeight: rbCurWeight,
              updatedAt: new Date().toISOString()
            };
            rbWriteBalances(balances);
          }

          rbWtDiff = rbOldWeight - rbCurWeight;
          rbWtAmount = rbWtDiff * rbRate;

          // Update bill record (if already saved earlier in this function)
          try {
            const billsNow = JSON.parse(localStorage.getItem("bills") || "[]");
            const bIdx = billsNow.findIndex(b => b.billNo === billNo.value);
            if (bIdx >= 0) {
              billsNow[bIdx].ratebook = {
                rate: rbRate,
                oldWeight: rbOldWeight,
                currentWeight: rbCurWeight,
                weightDiff: rbWtDiff,
                amount: rbWtAmount
              };
              localStorage.setItem("bills", JSON.stringify(billsNow));
            }
          } catch (e2) { }
        }
      } catch (e) {
        console.error("Ratebook weight adjustment failed (new-order):", e);
      }

      // Calculate totals from rows
      let totalPc = 0;
      let totalGrWt = 0;
      let orderType = "Order"; // Default type

      // Get the most common type from rows (or first non-empty type)
      const types = rows.map(r => r.type).filter(t => t && t !== "");
      if (types.length > 0) {
        // Count occurrences of each type
        const typeCount = {};
        types.forEach(t => {
          typeCount[t] = (typeCount[t] || 0) + 1;
        });
        // Get the most common type
        orderType = Object.keys(typeCount).reduce((a, b) =>
          typeCount[a] > typeCount[b] ? a : b
        );
      }

      rows.forEach(row => {
        const pc = parseFloat(row.values[7] || 0); // Column 7 is Pc
        const grWt = parseFloat(row.values[8] || 0); // Column 8 is Gr.Wt

        totalPc += pc;
        totalGrWt += grWt;
      });

      // Get advance from payments
      const payments = JSON.parse(localStorage.getItem("payments") || "[]");
      const advanceTotal = payments
        .filter(p => p.billNo === billNo.value)
        .reduce((sum, p) => sum + (Number(p.amount) || 0), 0);

      // Preserve original ID if editing, but update timestamp to show it was modified
      const orderId = existingOrder ? existingOrder.id : Date.now();
      const orderTimestamp = new Date().toISOString(); // Always update timestamp when saving

      const orderData = {
        id: orderId,
        orderNo: billNo.value,
        customer: getCustomerName(),
        customerId: custName.value,
        orderDate: orderDate.value,
        dueDate: dueDate.value || "",
        type: orderType, // Order, Sale, Purchase, Repair
        pc: totalPc,
        grWt: totalGrWt.toFixed(3),
        netAmount: billTotal.toFixed(2),
        advance: advanceTotal.toFixed(2),
        balance: (billTotal - advanceTotal).toFixed(2),
        status: existingOrder && existingOrder.status ? existingOrder.status : "PENDING", // Preserve status when editing
        items: rows,
        ratebookOrderedWeight: orderedNetWt.toFixed(3),
        ratebookDeliveredWeight: rbSafeNum(existingOrder && existingOrder.ratebookDeliveredWeight, 0).toFixed(3),
        timestamp: orderTimestamp
      };

      // Preserve any additional properties from existing order
      if (existingOrder) {
        Object.keys(existingOrder).forEach(key => {
          if (!orderData.hasOwnProperty(key) && key !== 'items') {
            orderData[key] = existingOrder[key];
          }
        });
      }

      // Update existing order by ID if found, otherwise by orderNo, or add new
      if (existingOrderByIdIndex >= 0) {
        orders[existingOrderByIdIndex] = orderData;
      } else if (existingOrderIndex >= 0) {
        orders[existingOrderIndex] = orderData;
      } else {
        orders.push(orderData);
      }
      localStorage.setItem("orders", JSON.stringify(orders));

      // Clear edit flags and re-enable fields
      if (editOrderId) {
        localStorage.removeItem("editOrderId");
        localStorage.removeItem("editCustomerReadOnly");

        // Re-enable Customer Name and Bill No fields
        if (custName) {
          custName.disabled = false;
          custName.style.backgroundColor = "";
          custName.style.cursor = "";
        }
        if (billNo) {
          billNo.readOnly = false;
          billNo.style.backgroundColor = "";
          billNo.style.cursor = "";
        }
      }

      // Dispatch event to refresh orders page
      const refreshEvent = new CustomEvent('orderSaved', {
        detail: { orderNo: billNo.value }
      });
      window.dispatchEvent(refreshEvent);
      if (window.parent && window.parent !== window) {
        window.parent.dispatchEvent(refreshEvent);
      }
      if (window.top && window.top !== window) {
        window.top.dispatchEvent(refreshEvent);
      }

      alert("Order saved successfully");

      // Update panel after saving
      updateInfoPanel();

      if (resetAfterSave) {
        resetOrder(true); // Skip confirmation since data is already saved
      }
    }

    /* SAVE & NEW */
    function saveAndNew() {
      saveOrder(true); // This will call resetOrder(true) after saving
    }

    /* RESET ORDER */
    function resetOrder(skipConfirmation = false) {
      if (!custName || !billNo || !orderDate || !itemBody) {
        if (!initElements()) {
          alert("Form not initialized. Please refresh the page.");
          return;
        }
      }

      if (!skipConfirmation && !confirm("Reset current order? All unsaved data will be lost.")) {
        return;
      }

      // If invoice view / popups are open, return to the order form
      if (invoice) invoice.style.display = "none";
      if (orderApp) orderApp.style.display = "block";
      if (orderPopup) orderPopup.style.display = "none";
      if (paymentPopup) paymentPopup.style.display = "none";

      // Reset customer
      if (custName) custName.value = "";
      if (currentBal) currentBal.value = "";
      if (relation) relation.value = "";
      if (station) station.value = "";

      // Reset bill info
      if (billNo) billNo.value = generateBillNo();
      if (orderDate) orderDate.valueAsDate = new Date();
      if (dueDate) dueDate.value = "";
      if (gstRate) gstRate.value = "";

      // Clear table rows
      if (itemBody) itemBody.innerHTML = "";
      addRow();

      // Clear edit flags and re-enable fields
      localStorage.removeItem("editOrderId");
      localStorage.removeItem("editCustomerReadOnly");

      // Clear saved state that might interfere
      localStorage.removeItem("newOrderState");
      localStorage.removeItem("ratebookOpened");
      localStorage.removeItem("receiptOpened");

      // Re-enable Customer Name and Bill No fields
      if (custName) {
        custName.disabled = false;
        custName.style.backgroundColor = "";
        custName.style.cursor = "";
      }
      if (billNo) {
        billNo.readOnly = false;
        billNo.style.backgroundColor = "";
        billNo.style.cursor = "";
      }

      // Ensure customer list is available after reset
      loadCustomers();

      // Update info panels to show empty state
      setTimeout(() => {
        updateInfoPanel();
        calc(); // Recalculate to update totals
      }, 100);

      // Focus for fast new entry
      setTimeout(() => {
        if (custName && typeof custName.focus === "function") custName.focus();
      }, 150);

      if (!skipConfirmation) {
        alert("Order reset successfully");
      }
    }

    /* LOAD ORDER FOR EDITING */
    function loadOrderForEdit(orderId) {
      if (!custName || !orderDate || !billNo || !itemBody) {
        if (!initElements()) {
          // Retry after a delay
          setTimeout(() => loadOrderForEdit(orderId), 100);
          return;
        }
      }

      const orders = JSON.parse(localStorage.getItem("orders") || "[]");
      const order = orders.find(o => o.id === Number(orderId));

      if (!order) {
        alert("Order not found");
        localStorage.removeItem("editOrderId");
        return;
      }

      // Load customers first
      loadCustomers();

      // Set customer
      if (order.customerId && custName) {
        const option = Array.from(custName.options).find(opt => opt.value === String(order.customerId));
        if (option) {
          custName.value = option.value;
          custName.dispatchEvent(new Event('change'));
        } else {
          // Fallback to name matching
          const optionByName = Array.from(custName.options).find(opt => opt.textContent === order.customer);
          if (optionByName) {
            custName.value = optionByName.value;
            custName.dispatchEvent(new Event('change'));
          }
        }
      } else if (order.customer && custName) {
        // Legacy: find by name
        const option = Array.from(custName.options).find(opt => opt.textContent === order.customer);
        if (option) {
          custName.value = option.value;
          custName.dispatchEvent(new Event('change'));
        }
      }

      // Load order details
      if (orderDate) orderDate.value = order.orderDate || orderDate.value;
      if (dueDate) dueDate.value = order.dueDate || "";
      if (billNo) {
        billNo.value = order.orderNo || order.billNo || billNo.value;
        // Make Bill No read-only when editing
        billNo.readOnly = true;
        billNo.style.backgroundColor = "#f5f5f7";
        billNo.style.cursor = "not-allowed";
      }
      if (gstRate) gstRate.value = order.gst || "";

      // Make Customer Name read-only when editing from orders page
      const isCustomerReadOnly = localStorage.getItem("editCustomerReadOnly");
      if (isCustomerReadOnly === "true" && custName) {
        custName.disabled = true;
        custName.style.backgroundColor = "#f5f5f7";
        custName.style.cursor = "not-allowed";
      }

      // Clear existing rows
      if (itemBody) itemBody.innerHTML = "";

      // Load order items
      if (order.items && order.items.length > 0) {
        order.items.forEach(item => {
          addRow();
          const tr = itemBody.lastElementChild;

          // Restore all field values
          if (item.values && item.values.length > 0) {
            tr.querySelectorAll("input,select").forEach((el, j) => {
              if (item.values[j] !== undefined && item.values[j] !== null) {
                el.value = item.values[j];
              }
            });
          }

          // Restore order metadata
          if (item.delivery || item.orderFilled) {
            tr.dataset.delivery = item.delivery || "";
            tr.dataset.sample = item.sample || "";
            tr.dataset.orderFilled = item.orderFilled || "";
          }

          // Recalculate row - trigger calc on Pc field (column 7)
          setTimeout(() => {
            if (tr.cells[7] && tr.cells[7].children[0]) {
              calc(tr.cells[7].children[0]);
            }
          }, 10);
        });
      } else {
        addRow();
      }

      // Update panel after loading order
      setTimeout(() => {
        updateInfoPanel();
      }, 200);

      // Keep editOrderId until order is saved (don't remove it here)
      // It will be removed in saveOrder function after saving
    }

    function loadBill(i) {
      if (!custName || !orderDate || !billNo || !itemBody) {
        if (!initElements()) {
          setTimeout(() => loadBill(i), 100);
          return;
        }
      }

      const bills = JSON.parse(localStorage.getItem("bills") || "[]");
      if (!bills[i]) {
        alert("Bill not found");
        return;
      }

      const b = bills[i];

      // Load customers first
      loadCustomers();

      // Set customer - try by ID first, then by name
      if (b.customerId && custName) {
        const option = Array.from(custName.options).find(opt => opt.value === String(b.customerId));
        if (option) {
          custName.value = option.value;
          custName.dispatchEvent(new Event('change'));
        } else {
          // Fallback to name matching
          const optionByName = Array.from(custName.options).find(opt => opt.textContent === b.customer);
          if (optionByName) {
            custName.value = optionByName.value;
            custName.dispatchEvent(new Event('change'));
          }
        }
      } else if (b.customer && custName) {
        // Legacy: find by name
        const option = Array.from(custName.options).find(opt => opt.textContent === b.customer);
        if (option) {
          custName.value = option.value;
          custName.dispatchEvent(new Event('change'));
        }
      }

      if (orderDate) orderDate.value = b.date;
      if (billNo) billNo.value = b.billNo;
      if (itemBody) itemBody.innerHTML = "";

      b.rows.forEach(r => {
        addRow();
        const tr = itemBody.lastElementChild;
        tr.querySelectorAll("input,select").forEach((el, j) => el.value = r.values[j]);

        // Restore all order metadata
        if (r.delivery || r.orderFilled) {
          tr.dataset.delivery = r.delivery || "";
          tr.dataset.sample = r.sample || "";
          tr.dataset.orderFilled = r.orderFilled || "";
        }

        // Recalculate row - trigger calc on Pc field (column 7)
        setTimeout(() => {
          if (tr.cells[7] && tr.cells[7].children[0]) {
            calc(tr.cells[7].children[0]);
          }
        }, 10);
      });
    }

    /* INVOICE */
    function showInvoice() {
      if (!orderDate || !billNo || !itemBody) {
        if (!initElements()) {
          alert("Form not initialized. Please refresh the page.");
          return;
        }
      }

      if (!iCustomer || !iOrderDate || !iBillNo || !iItems) {
        // Try to reinitialize invoice elements
        const workspace = document.querySelector(".workspace");
        const searchRoot = workspace || document;
        iCustomer = searchRoot.querySelector("#iCustomer") || document.getElementById("iCustomer");
        iOrderDate = searchRoot.querySelector("#iOrderDate") || document.getElementById("iOrderDate");
        iBillNo = searchRoot.querySelector("#iBillNo") || document.getElementById("iBillNo");
        iItems = searchRoot.querySelector("#iItems") || document.getElementById("iItems");
        iGrand = searchRoot.querySelector("#iGrand") || document.getElementById("iGrand");
      }

      if (!iCustomer || !iOrderDate || !iBillNo || !iItems) {
        alert("Invoice elements not found");
        return;
      }

      if (iCustomer) iCustomer.textContent = getCustomerName() || "‚Äî";
      if (iOrderDate) iOrderDate.textContent = orderDate.value || "‚Äî";
      if (iBillNo) iBillNo.textContent = billNo.value || "‚Äî";

      const workspace = document.querySelector(".workspace");
      const searchRoot = workspace || document;
      const invoiceDateEl = searchRoot.querySelector("#iInvoiceDate") || document.getElementById("iInvoiceDate");
      if (invoiceDateEl) invoiceDateEl.textContent = new Date().toLocaleDateString();

      if (iItems) iItems.innerHTML = "";
      let g = 0;
      itemBody.querySelectorAll("tr").forEach(r => {
        if (r.cells[13] && r.cells[13].children[0]) {
          const t = +r.cells[13].children[0].value || 0;
          g += t;
          const delivery = r.dataset.delivery || "";
          const sample = r.dataset.sample || "";
          const itemType = r.cells[0] && r.cells[0].children[0] ? r.cells[0].children[0].value : "";
          const orderDetails = (itemType === "Order" && delivery) ? `Delivery: ${delivery}${sample ? ' | Sample: ' + sample : ''}` : "‚Äî";
          const itemName = (r.cells[2] && r.cells[2].children[0] ? r.cells[2].children[0].value || "‚Äî" : "‚Äî").substring(0, 25);
          const rowHTML = `
<tr>
  <td style="word-break:break-word; font-size:9px;">${itemName}</td>
  <td style="font-size:9px;">${r.cells[7] && r.cells[7].children[0] ? r.cells[7].children[0].value || "0" : "0"}</td>
  <td style="font-size:9px;">${r.cells[10] && r.cells[10].children[0] ? r.cells[10].children[0].value || "0" : "0"}</td>
  <td style="font-size:9px;">${r.cells[11] && r.cells[11].children[0] ? r.cells[11].children[0].value || "0" : "0"}</td>
  <td style="font-size:9px;">${t.toFixed(2)}</td>
  <td style="font-size:8px; word-break:break-word;">${orderDetails}</td>
</tr>`;
          if (iItems) iItems.innerHTML += rowHTML;
        }
      });

      // Calculate payment info
      const total = g;
      const paid = getPaidAmount(billNo.value);
      const balance = total - paid;

      if (iGrand) iGrand.textContent = total.toFixed(2);
      const iPaidEl = searchRoot.querySelector("#iPaid") || document.getElementById("iPaid");
      const iBalanceEl = searchRoot.querySelector("#iBalance") || document.getElementById("iBalance");
      if (iPaidEl) iPaidEl.textContent = paid.toFixed(2);
      if (iBalanceEl) iBalanceEl.textContent = balance.toFixed(2);

      // Ratebook difference (uses latest Ratebook rate per Stamp)
      const iRatebookTotalEl = searchRoot.querySelector("#iRatebookTotal") || document.getElementById("iRatebookTotal");
      const iRateDiffEl = searchRoot.querySelector("#iRateDiff") || document.getElementById("iRateDiff");
      const iRateDiffSignEl = searchRoot.querySelector("#iRateDiffSign") || document.getElementById("iRateDiffSign");
      const iRateDiffRow = searchRoot.querySelector("#iRateDiffRow") || document.getElementById("iRateDiffRow");

      const rbTotal = calculateRatebookTotalForBill();
      const diff = total - rbTotal;
      if (iRatebookTotalEl) iRatebookTotalEl.textContent = rbTotal.toFixed(2);
      if (iRateDiffEl) iRateDiffEl.textContent = Math.abs(diff).toFixed(2);
      if (iRateDiffSignEl) iRateDiffSignEl.textContent = diff >= 0 ? "+" : "‚àí";
      if (iRateDiffRow) {
        // Red when bill > ratebook, green when bill < ratebook
        iRateDiffRow.style.color = diff >= 0 ? "#dc3545" : "#28a745";
      }

      // Ratebook Weight (Old vs Current) ‚Üí Amount in bill
      try {
        const iRbRateEl = searchRoot.querySelector("#iRbRate") || document.getElementById("iRbRate");
        const iRbOldWtEl = searchRoot.querySelector("#iRbOldWt") || document.getElementById("iRbOldWt");
        const iRbCurWtEl = searchRoot.querySelector("#iRbCurWt") || document.getElementById("iRbCurWt");
        const iRbWtSignEl = searchRoot.querySelector("#iRbWtSign") || document.getElementById("iRbWtSign");
        const iRbWtDiffEl = searchRoot.querySelector("#iRbWtDiff") || document.getElementById("iRbWtDiff");
        const iRbWtAmtEl = searchRoot.querySelector("#iRbWtAmt") || document.getElementById("iRbWtAmt");

        // Prefer stored bill ratebook snapshot (after Save), otherwise compute a "would-be" snapshot.
        let snap = null;
        try {
          const bills = JSON.parse(localStorage.getItem("bills") || "[]");
          const b = bills.find(x => x && x.billNo === billNo.value);
          if (b && b.ratebook) snap = b.ratebook;
        } catch (e) { }

        let rate = 0, oldW = 0, curW = 0;
        if (snap) {
          rate = rbSafeNum(snap.rate, 0);
          oldW = rbSafeNum(snap.oldWeight, 0);
          curW = rbSafeNum(snap.currentWeight, 0);
        } else {
          const customerId = custName && custName.value ? custName.value : "";
          const orderedNetWt = (() => {
            let sum = 0;
            itemBody.querySelectorAll("tr").forEach(tr => {
              const net = parseFloat(tr.cells[10] && tr.cells[10].children[0] ? tr.cells[10].children[0].value : "0") || 0;
              sum += net;
            });
            return sum;
          })();

          const { record } = rbGetCustomerRecord(customerId, getCustomerName());
          rate = record.rate;
          oldW = record.currentWeight;

          // Find existing order for idempotent delta
          const orders = JSON.parse(localStorage.getItem("orders") || "[]");
          const editOrderId = localStorage.getItem("editOrderId");
          let existingOrder = null;
          if (editOrderId) {
            const oid = Number(editOrderId);
            existingOrder = orders.find(o => o && (o.id === oid || o.id === editOrderId || String(o.id) === String(editOrderId)));
          }
          if (!existingOrder) {
            existingOrder = orders.find(o => o && o.orderNo === billNo.value);
          }

          const prevOrdered = rbSafeNum(existingOrder && existingOrder.ratebookOrderedWeight, 0);
          const prevDelivered = rbSafeNum(existingOrder && existingOrder.ratebookDeliveredWeight, 0);
          if (prevDelivered > 0) {
            curW = oldW;
          } else {
            curW = oldW + (prevOrdered - orderedNetWt);
          }
        }

        const wtDiff = oldW - curW;
        const wtAmt = wtDiff * rate;

        if (iRbRateEl) iRbRateEl.textContent = rate.toFixed(2);
        if (iRbOldWtEl) iRbOldWtEl.textContent = oldW.toFixed(3);
        if (iRbCurWtEl) iRbCurWtEl.textContent = curW.toFixed(3);
        if (iRbWtDiffEl) iRbWtDiffEl.textContent = Math.abs(wtDiff).toFixed(3);
        if (iRbWtSignEl) iRbWtSignEl.textContent = wtDiff >= 0 ? "‚àí" : "+";
        if (iRbWtAmtEl) iRbWtAmtEl.textContent = Math.abs(wtAmt).toFixed(2);
      } catch (e) {
        console.debug("Ratebook weight summary not available:", e);
      }

      // Get all payments for this bill
      const payments = JSON.parse(localStorage.getItem("payments") || "[]");
      const billPayments = payments.filter(p => p.billNo === billNo.value);

      // Display payment details in table
      const paymentDetailsEl = document.getElementById("paymentDetails");
      const invoicePaymentBody = document.getElementById("invoicePaymentBody");
      if (paymentDetailsEl && invoicePaymentBody) {
        invoicePaymentBody.innerHTML = "";
        if (billPayments.length > 0) {
          billPayments.forEach(p => {
            const narration = (p.narration || "‚Äî").substring(0, 40);
            const date = p.date ? new Date(p.date).toLocaleDateString() : "‚Äî";
            const row = document.createElement("tr");
            row.innerHTML = `
          <td style="font-size:9px;">${date}</td>
          <td style="font-size:9px;">‚Çπ ${(Number(p.amount) || 0).toFixed(2)}</td>
          <td style="font-size:9px;">${(p.mode || "‚Äî").substring(0, 10)}</td>
          <td style="font-size:9px;">${(p.batch || "‚Äî").substring(0, 10)}</td>
          <td style="font-size:9px;">${(p.type || "‚Äî").substring(0, 10)}</td>
          <td style="font-size:8px; word-break:break-word;">${narration}</td>
        `;
            invoicePaymentBody.appendChild(row);
          });
          paymentDetailsEl.style.display = "block";
        } else {
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="6" style="text-align:center; font-size:9px; color:#999;">No payments recorded</td>`;
          invoicePaymentBody.appendChild(row);
          paymentDetailsEl.style.display = "block";
        }
      }

      // Get ratebook entries that are actually applied to this order
      // Only show rates that are used in the current order rows
      const appliedRates = [];
      if (itemBody) {
        itemBody.querySelectorAll("tr").forEach(tr => {
          const rateInput = tr.cells[11] && tr.cells[11].children[0];
          if (rateInput && rateInput.value && parseFloat(rateInput.value) > 0) {
            const stampInput = tr.cells[3] && tr.cells[3].children[0];
            const itemNameInput = tr.cells[2] && tr.cells[2].children[0];
            appliedRates.push({
              rate: rateInput.value,
              stamp: stampInput ? stampInput.value : "",
              itemName: itemNameInput ? itemNameInput.value : "",
              date: new Date().toLocaleDateString(),
              applied: true
            });
          }
        });
      }

      // Display ratebook details in table - only show applied rates
      const ratebookDetailsEl = document.getElementById("ratebookDetails");
      const invoiceRatebookBody = document.getElementById("invoiceRatebookBody");
      if (ratebookDetailsEl && invoiceRatebookBody) {
        invoiceRatebookBody.innerHTML = "";
        if (appliedRates.length > 0) {
          appliedRates.forEach(r => {
            const itemName = (r.itemName || "‚Äî").substring(0, 20);
            const row = document.createElement("tr");
            row.innerHTML = `
          <td style="font-size:9px;">${r.date}</td>
          <td style="font-size:9px;">${itemName}</td>
          <td style="font-size:9px;">${(r.stamp || "‚Äî").substring(0, 10)}</td>
          <td style="font-size:9px;">‚Äî</td>
          <td style="font-size:9px;">‚Çπ ${(Number(r.rate) || 0).toFixed(2)}</td>
          <td style="font-size:9px;">‚Äî</td>
          <td style="font-size:8px; word-break:break-word;">Applied to order</td>
        `;
            invoiceRatebookBody.appendChild(row);
          });
          ratebookDetailsEl.style.display = "block";
        } else {
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="7" style="text-align:center; font-size:9px; color:#999;">No rates applied to this order</td>`;
          invoiceRatebookBody.appendChild(row);
          ratebookDetailsEl.style.display = "block";
        }
      }

      // Get ALL receipts (from receipts storage, not payments)
      const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");
      const customerName = getCustomerName();

      // Filter receipts: show receipts for current bill first, then all recent saved receipts
      let displayReceipts = [];
      if (billNo && billNo.value) {
        // Show receipts for this bill first
        const billReceipts = receipts.filter(r => r.billNo === billNo.value);
        // Also include recent receipts without billNo (last 10) to show all saved receipts
        const recentNoBill = receipts
          .filter(r => !r.billNo || r.billNo === "")
          .sort((a, b) => {
            const dateA = new Date(a.timestamp || a.date || 0);
            const dateB = new Date(b.timestamp || b.date || 0);
            return dateB - dateA;
          })
          .slice(0, 10);
        displayReceipts = [...billReceipts, ...recentNoBill];
      } else if (customerName) {
        // Show receipts for this customer (with or without billNo)
        displayReceipts = receipts.filter(r => r.customer === customerName);
      } else {
        // Show all recent receipts (most recent 20) - show all saved receipts
        displayReceipts = receipts
          .sort((a, b) => {
            const dateA = new Date(a.timestamp || a.date || 0);
            const dateB = new Date(b.timestamp || b.date || 0);
            return dateB - dateA;
          })
          .slice(0, 20);
      }

      // Remove duplicates based on receipt ID
      const uniqueReceipts = [];
      const seenIds = new Set();
      displayReceipts.forEach(r => {
        if (r.id && !seenIds.has(r.id)) {
          seenIds.add(r.id);
          uniqueReceipts.push(r);
        } else if (!r.id) {
          // Handle old receipts without ID - use timestamp as unique identifier
          const uniqueKey = `${r.timestamp || r.date || ''}_${r.amount}_${r.customer || ''}_${r.billNo || ''}`;
          if (!seenIds.has(uniqueKey)) {
            seenIds.add(uniqueKey);
            uniqueReceipts.push(r);
          }
        }
      });
      displayReceipts = uniqueReceipts;

      // Display receipt details in table
      const receiptDetailsEl = document.getElementById("receiptDetails");
      const invoiceReceiptBody = document.getElementById("invoiceReceiptBody");
      if (receiptDetailsEl && invoiceReceiptBody) {
        invoiceReceiptBody.innerHTML = "";
        if (displayReceipts.length > 0) {
          // Sort by date (newest first)
          const sortedReceipts = [...displayReceipts].sort((a, b) => {
            const dateA = new Date(a.timestamp || a.date || 0);
            const dateB = new Date(b.timestamp || b.date || 0);
            return dateB - dateA;
          });

          sortedReceipts.forEach(r => {
            const date = r.date ? new Date(r.date).toLocaleDateString() : (r.timestamp ? new Date(r.timestamp).toLocaleDateString() : "‚Äî");
            let narration = r.narration || "";
            // Add additional fields to narration if they exist
            const extraInfo = [];
            if (r.batch) extraInfo.push(`Batch: ${r.batch}`);
            if (r.expDate) extraInfo.push(`Exp: ${r.expDate}`);
            if (r.apCode) extraInfo.push(`Code: ${r.apCode}`);
            if (extraInfo.length > 0) {
              narration = narration ? `${narration} | ${extraInfo.join(', ')}` : extraInfo.join(', ');
            }
            narration = narration.substring(0, 50);
            const billNoDisplay = (r.billNo || "‚Äî").substring(0, 12);
            const amount = (Number(r.amount) || 0).toFixed(2);
            const mode = (r.mode || "‚Äî").substring(0, 10);
            const type = (r.type || r.ptype || "‚Äî").substring(0, 10);

            const row = document.createElement("tr");
            row.innerHTML = `
          <td style="font-size:9px;">${date}</td>
          <td style="font-size:9px;">${billNoDisplay}</td>
          <td style="font-size:9px;">‚Çπ ${amount}</td>
          <td style="font-size:9px;">${mode}</td>
          <td style="font-size:9px;">${type}</td>
          <td style="font-size:8px; word-break:break-word;">${narration || "‚Äî"}</td>
          <td style="font-size:9px; text-align:center;">
            <button onclick="deleteReceipt(${r.id ? r.id : 'null'}, '${(r.timestamp || r.date || '').replace(/'/g, "\\'")}')" style="background:#ff3b30; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:10px;">‚ùå</button>
          </td>
        `;
            invoiceReceiptBody.appendChild(row);
          });
          receiptDetailsEl.style.display = "block";
        } else {
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="7" style="text-align:center; font-size:9px; color:#999;">No receipts available</td>`;
          invoiceReceiptBody.appendChild(row);
          receiptDetailsEl.style.display = "block";
        }
      }

      if (invoice) invoice.style.display = "block";
      if (orderApp) orderApp.style.display = "none";
    }

    // Ratebook total = Œ£(NetWt √ó RatebookRate √ó (1 + Lbr%/100)) using latest rate per Stamp
    function calculateRatebookTotalForBill() {
      try {
        if (!itemBody) return 0;
        const rates = JSON.parse(localStorage.getItem("rateBook") || "[]");
        if (!rates || rates.length === 0) return 0;

        const normalizeStamp = (s) => String(s || "").trim().toUpperCase();
        // Build latest-rate map by stamp
        const sorted = [...rates].sort((a, b) => {
          const da = new Date(a.timestamp || a.date || 0);
          const db = new Date(b.timestamp || b.date || 0);
          return db - da;
        });
        const stampToRate = new Map();
        for (const r of sorted) {
          const key = normalizeStamp(r.stamp);
          if (!key) continue;
          if (!stampToRate.has(key)) {
            stampToRate.set(key, Number(r.rate) || 0);
          }
        }

        let total = 0;
        itemBody.querySelectorAll("tr").forEach(tr => {
          // Columns: Stamp=3, NetWt=10, Lbr%=12 (new-order.html table)
          const stamp = normalizeStamp(tr.cells[3] && tr.cells[3].children[0] ? tr.cells[3].children[0].value : "");
          if (!stamp) return;
          const rbRate = stampToRate.get(stamp);
          if (!rbRate || rbRate <= 0) return;

          const netWt = parseFloat(tr.cells[10] && tr.cells[10].children[0] ? tr.cells[10].children[0].value : "0") || 0;
          if (netWt <= 0) return;
          const lbr = parseFloat(tr.cells[12] && tr.cells[12].children[0] ? tr.cells[12].children[0].value : "0") || 0;

          const base = netWt * rbRate;
          const labor = base * (lbr / 100);
          total += (base + labor);
        });
        return total;
      } catch (e) {
        console.error("Error calculating ratebook total:", e);
        return 0;
      }
    }

    /* REFRESH RECEIPT TABLE IN INVOICE */
    function refreshInvoiceReceiptTable() {
      // Get ALL receipts (from receipts storage, not payments)
      const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");
      const customerName = getCustomerName();

      // Filter receipts: show receipts for current bill first, then all recent saved receipts
      let displayReceipts = [];
      if (billNo && billNo.value) {
        // Show receipts for this bill first
        const billReceipts = receipts.filter(r => r.billNo === billNo.value);
        // Also include recent receipts without billNo (last 10) to show all saved receipts
        const recentNoBill = receipts
          .filter(r => !r.billNo || r.billNo === "")
          .sort((a, b) => {
            const dateA = new Date(a.timestamp || a.date || 0);
            const dateB = new Date(b.timestamp || b.date || 0);
            return dateB - dateA;
          })
          .slice(0, 10);
        displayReceipts = [...billReceipts, ...recentNoBill];
      } else if (customerName) {
        // Show receipts for this customer (with or without billNo)
        displayReceipts = receipts.filter(r => r.customer === customerName);
      } else {
        // Show all recent receipts (most recent 20) - show all saved receipts
        displayReceipts = receipts
          .sort((a, b) => {
            const dateA = new Date(a.timestamp || a.date || 0);
            const dateB = new Date(b.timestamp || b.date || 0);
            return dateB - dateA;
          })
          .slice(0, 20);
      }

      // Remove duplicates based on receipt ID
      const uniqueReceipts = [];
      const seenIds = new Set();
      displayReceipts.forEach(r => {
        if (r.id && !seenIds.has(r.id)) {
          seenIds.add(r.id);
          uniqueReceipts.push(r);
        } else if (!r.id) {
          // Handle old receipts without ID - use timestamp as unique identifier
          const uniqueKey = `${r.timestamp || r.date || ''}_${r.amount}_${r.customer || ''}_${r.billNo || ''}`;
          if (!seenIds.has(uniqueKey)) {
            seenIds.add(uniqueKey);
            uniqueReceipts.push(r);
          }
        }
      });
      displayReceipts = uniqueReceipts;

      // Display receipt details in table
      const receiptDetailsEl = document.getElementById("receiptDetails");
      const invoiceReceiptBody = document.getElementById("invoiceReceiptBody");
      if (receiptDetailsEl && invoiceReceiptBody) {
        invoiceReceiptBody.innerHTML = "";
        if (displayReceipts.length > 0) {
          // Sort by date (newest first)
          const sortedReceipts = [...displayReceipts].sort((a, b) => {
            const dateA = new Date(a.timestamp || a.date || 0);
            const dateB = new Date(b.timestamp || b.date || 0);
            return dateB - dateA;
          });

          sortedReceipts.forEach(r => {
            const date = r.date ? new Date(r.date).toLocaleDateString() : (r.timestamp ? new Date(r.timestamp).toLocaleDateString() : "‚Äî");
            let narration = r.narration || "";
            // Add additional fields to narration if they exist
            const extraInfo = [];
            if (r.batch) extraInfo.push(`Batch: ${r.batch}`);
            if (r.expDate) extraInfo.push(`Exp: ${r.expDate}`);
            if (r.apCode) extraInfo.push(`Code: ${r.apCode}`);
            if (extraInfo.length > 0) {
              narration = narration ? `${narration} | ${extraInfo.join(', ')}` : extraInfo.join(', ');
            }
            narration = narration.substring(0, 50);
            const billNoDisplay = (r.billNo || "‚Äî").substring(0, 12);
            const amount = (Number(r.amount) || 0).toFixed(2);
            const mode = (r.mode || "‚Äî").substring(0, 10);
            const type = (r.type || r.ptype || "‚Äî").substring(0, 10);

            const row = document.createElement("tr");
            row.dataset.receiptId = r.id || '';
            row.dataset.receiptTimestamp = r.timestamp || r.date || '';
            row.innerHTML = `
          <td style="font-size:9px;">${date}</td>
          <td style="font-size:9px;">${billNoDisplay}</td>
          <td style="font-size:9px;">‚Çπ ${amount}</td>
          <td style="font-size:9px;">${mode}</td>
          <td style="font-size:9px;">${type}</td>
          <td style="font-size:8px; word-break:break-word;">${narration || "‚Äî"}</td>
          <td style="font-size:9px; text-align:center;">
            <button class="delete-receipt-btn" style="background:#ff3b30; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:10px;">‚ùå</button>
          </td>
        `;
            // Add click handler to delete button
            const deleteBtn = row.querySelector('.delete-receipt-btn');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', function () {
                const receiptId = row.dataset.receiptId ? Number(row.dataset.receiptId) : null;
                const timestamp = row.dataset.receiptTimestamp || '';
                deleteReceipt(receiptId, timestamp);
              });
            }
            invoiceReceiptBody.appendChild(row);
          });
          receiptDetailsEl.style.display = "block";
        } else {
          const row = document.createElement("tr");
          row.innerHTML = `<td colspan="7" style="text-align:center; font-size:9px; color:#999;">No receipts available</td>`;
          invoiceReceiptBody.appendChild(row);
          receiptDetailsEl.style.display = "block";
        }
      }
    }

    function back() {
      if (!invoice || !orderApp) {
        if (!initElements()) return;
      }
      if (invoice) invoice.style.display = "none";
      if (orderApp) orderApp.style.display = "block";
    }

    /* PAYMENT POPUP */
    function openPayment() {
      if (!custName || !billNo) {
        if (!initElements()) {
          alert("Form not initialized. Please refresh the page.");
          return;
        }
      }

      if (!custName.value) { alert("Select customer first"); return; }
      if (!billNo.value) { alert("Bill number is required"); return; }

      // Calculate and show bill total
      const total = calculateBillTotal();

      // Find payment elements in workspace or document
      const workspace = document.querySelector(".workspace");
      const searchRoot = workspace || document;

      if (!paymentBillTotal) {
        paymentBillTotal = searchRoot.querySelector("#paymentBillTotal") || document.getElementById("paymentBillTotal");
      }
      if (!paymentAmountDisplay) {
        paymentAmountDisplay = searchRoot.querySelector("#paymentAmountDisplay") || document.getElementById("paymentAmountDisplay");
      }
      if (!paymentBalance) {
        paymentBalance = searchRoot.querySelector("#paymentBalance") || document.getElementById("paymentBalance");
      }
      if (!paymentPopup) {
        paymentPopup = searchRoot.querySelector("#paymentPopup") || document.getElementById("paymentPopup");
      }

      if (paymentBillTotal) {
        paymentBillTotal.textContent = total.toFixed(2);
      }

      // Reset form fields
      const amountEl = searchRoot.querySelector("#amount") || document.getElementById("amount");
      const narrationEl = searchRoot.querySelector("#narration") || document.getElementById("narration");
      const modeEl = searchRoot.querySelector("#mode") || document.getElementById("mode");
      const batchEl = searchRoot.querySelector("#batch") || document.getElementById("batch");
      const typeEl = searchRoot.querySelector("#type") || document.getElementById("type");
      const expDateEl = searchRoot.querySelector("#expDate") || document.getElementById("expDate");
      const apCodeEl = searchRoot.querySelector("#apCode") || document.getElementById("apCode");

      if (amountEl) amountEl.value = "";
      if (narrationEl) narrationEl.value = "";
      if (modeEl) modeEl.value = "Cash";
      if (batchEl) batchEl.value = "";
      if (typeEl) typeEl.value = "";
      if (expDateEl) expDateEl.value = "";
      if (apCodeEl) apCodeEl.value = "";

      const cashRadio = searchRoot.querySelector('input[name="ptype"][value="Cash"]') || document.querySelector('input[name="ptype"][value="Cash"]');
      if (cashRadio) cashRadio.checked = true;

      // Reset display
      if (paymentAmountDisplay) paymentAmountDisplay.textContent = "0.00";
      if (paymentBalance) {
        paymentBalance.textContent = total.toFixed(2);
        paymentBalance.style.color = "#dc3545";
      }

      if (paymentPopup) paymentPopup.style.display = "flex";
    }

    function calculatePaymentBalance() {
      const total = calculateBillTotal();
      const amount = Number(document.getElementById("amount").value || 0);
      const balance = total - amount;

      if (paymentAmountDisplay) {
        paymentAmountDisplay.textContent = amount.toFixed(2);
      }

      if (paymentBalance) {
        paymentBalance.textContent = balance.toFixed(2);
        if (balance < 0) {
          paymentBalance.style.color = "#dc3545";
        } else if (balance === 0) {
          paymentBalance.style.color = "#28a745";
        } else {
          paymentBalance.style.color = "#dc3545";
        }
      }
    }

    function closePaymentPopup() {
      paymentPopup.style.display = "none";
      document.getElementById("amount").value = "";
      document.getElementById("narration").value = "";
    }

    function savePaymentFromPopup() {
      const amountEl = document.getElementById("amount");
      const modeEl = document.getElementById("mode");
      const narrationEl = document.getElementById("narration");
      const batchEl = document.getElementById("batch");
      const typeEl = document.getElementById("type");
      const expDateEl = document.getElementById("expDate");
      const apCodeEl = document.getElementById("apCode");
      const ptypeEl = document.querySelector('input[name="ptype"]:checked');

      const amt = Number(amountEl.value || 0);
      if (!amt || amt <= 0) {
        alert("Enter valid amount");
        return;
      }

      if (!billNo.value) {
        alert("Bill number is required");
        return;
      }

      const payments = JSON.parse(localStorage.getItem("payments") || "[]");

      payments.push({
        billNo: billNo.value,
        customer: getCustomerName(),
        customerId: custName.value,
        amount: amt,
        mode: modeEl.value,
        narration: narrationEl.value,
        batch: batchEl.value,
        type: typeEl.value,
        expDate: expDateEl.value,
        apCode: apCodeEl.value,
        ptype: ptypeEl ? ptypeEl.value : "Cash",
        date: new Date().toISOString().split("T")[0],
        timestamp: new Date().toISOString()
      });

      localStorage.setItem("payments", JSON.stringify(payments));

      // Update bill total if not set
      const bills = JSON.parse(localStorage.getItem("bills") || "[]");
      const billIndex = bills.findIndex(b => b.billNo === billNo.value);
      if (billIndex >= 0) {
        if (!bills[billIndex].totalAmount) {
          bills[billIndex].totalAmount = calculateBillTotal();
          localStorage.setItem("bills", JSON.stringify(bills));
        }
      }

      // Dispatch event to update panel
      window.dispatchEvent(new CustomEvent('paymentSaved'));
      if (window.parent && window.parent !== window) {
        window.parent.dispatchEvent(new CustomEvent('paymentSaved'));
      }

      alert("Payment saved successfully");
      closePaymentPopup();
      updateInfoPanel();
    }

    /* NAV */
    function openReceipt() {
      if (!custName || !billNo) {
        if (!initElements()) {
          alert("Form not initialized. Please refresh the page.");
          return;
        }
      }

      const customerName = getCustomerName();
      if (!customerName) {
        alert("Select customer first");
        return;
      }

      if (!billNo.value) {
        alert("Bill number is required");
        return;
      }

      // Return target for Receipt ‚Üí back to this page
      localStorage.setItem("receiptReturnTarget", "pages/new-order.html");
      // Force restore even if flags get cleared elsewhere
      localStorage.setItem("newOrderForceRestore", "true");

      // Save current new-order page state before opening receipt
      // This allows us to restore it when receipt closes
      saveOrderState();

      // Mark that we're opening receipt (so we know to restore on return)
      localStorage.setItem("receiptOpened", "true");

      // Open receipt page with customer, customerId, and bill number
      const customerId = custName.value || "";
      const receiptUrl = `pages/receipt.html?customer=${encodeURIComponent(customerName)}&customerId=${encodeURIComponent(customerId)}&billNo=${encodeURIComponent(billNo.value)}`;

      if (typeof loadPage === 'function') {
        // If in dashboard context, load in workspace
        // The workspace will replace content, but we've saved state
        loadPage(receiptUrl);
      } else {
        // Otherwise open in new window (this preserves current page)
        window.open(receiptUrl, "Receipt", "width=800,height=700");
      }
    }

    /* RATE BOOK - Same logic but opens separate page */
    let activeRateRow = null; // Store the row that opened rate book (for applying rate)

    function openRateBook(rowElement = null) {
      // Store customer + bill context for Rate Book and prefill Amount Difference
      try {
        localStorage.setItem("ratebookCustomerId", custName && custName.value ? custName.value : "");
        localStorage.setItem("ratebookCustomerName", getCustomerName() || "");
        localStorage.setItem("ratebookBillNo", billNo && billNo.value ? billNo.value : "");
        const suggestedDiff = calculateBillTotal() - calculateRatebookTotalForBill();
        localStorage.setItem("ratebookAmountDifference", (Number(suggestedDiff) || 0).toFixed(2));
      } catch (e) { }

      // Store the active row if rate book was opened from a row
      activeRateRow = rowElement;

      // Store active row info in localStorage so ratebook.html can access it
      if (rowElement) {
        localStorage.setItem("activeRateRow", "true");
      } else {
        localStorage.removeItem("activeRateRow");
      }

      // Return target for Ratebook ‚Üí back to this page
      localStorage.setItem("ratebookReturnTarget", "pages/new-order.html");
      // Try to remember the row index (optional)
      try {
        let idx = -1;
        if (itemBody && rowElement) {
          const tr = rowElement.closest ? rowElement.closest("tr") : rowElement;
          const trs = Array.from(itemBody.querySelectorAll("tr"));
          idx = trs.indexOf(tr);
        }
        localStorage.setItem("ratebookTargetRowIndex", String(idx));
      } catch (e) {
        localStorage.setItem("ratebookTargetRowIndex", "-1");
      }
      // Force restore even if flags get cleared elsewhere
      localStorage.setItem("newOrderForceRestore", "true");

      // Save current new-order page state before opening ratebook
      // This allows us to restore it when ratebook closes
      // IMPORTANT: Save state BEFORE opening ratebook to preserve all data
      saveOrderState();

      // Mark that we're opening ratebook (so we know to restore on return)
      localStorage.setItem("ratebookOpened", "true");

      // Open rate book page - same logic flow, just different UI
      if (typeof loadPage === 'function') {
        // If in dashboard context, load in workspace
        // The workspace will replace content, but we've saved state
        loadPage("pages/ratebook.html");
      } else {
        // Otherwise open in new window (this preserves current page)
        window.open("/pages/ratebook.html", "RateBook", "width=800,height=700");
      }
    }

    /* SAVE ORDER STATE - Save form data before opening ratebook */
    function saveOrderState() {
      if (!custName || !billNo || !orderDate || !itemBody) {
        if (!initElements()) return;
      }

      try {
        const orderState = {
          customerId: custName ? custName.value : "",
          billNo: billNo ? billNo.value : "",
          orderDate: orderDate ? orderDate.value : "",
          dueDate: dueDate ? dueDate.value : "",
          gstRate: gstRate ? gstRate.value : "",
          rows: []
        };

        // Save all row data
        if (itemBody) {
          itemBody.querySelectorAll("tr").forEach(tr => {
            const rowData = {
              values: [...tr.querySelectorAll("input,select")].map(el => el.value),
              type: tr.cells[0] && tr.cells[0].children[0] ? tr.cells[0].children[0].value : "",
              delivery: tr.dataset.delivery || "",
              sample: tr.dataset.sample || "",
              orderFilled: tr.dataset.orderFilled || ""
            };
            orderState.rows.push(rowData);
          });
        }

        localStorage.setItem("newOrderState", JSON.stringify(orderState));
      } catch (e) {
        console.error("Error saving order state:", e);
      }
    }

    /* RESTORE ORDER STATE - Restore form data after closing ratebook */
    function restoreOrderState() {
      if (!custName || !billNo || !orderDate || !itemBody) {
        if (!initElements()) {
          // Retry after a delay
          setTimeout(restoreOrderState, 100);
          return;
        }
      }

      try {
        const savedState = localStorage.getItem("newOrderState");
        if (!savedState) {
          // No saved state, but check if we have existing data - preserve it
          if (itemBody && itemBody.querySelectorAll("tr").length === 0) {
            addRow();
          }
          return;
        }

        const orderState = JSON.parse(savedState);

        // Load customers first (needed for customer selection)
        loadCustomers();

        // Wait a bit for customers to load, then restore
        setTimeout(() => {
          // If we opened Ratebook/Receipt, we MUST restore exactly (overwriting generated fields)
          const forceRestore =
            localStorage.getItem("newOrderForceRestore") === "true" ||
            localStorage.getItem("ratebookOpened") === "true" ||
            localStorage.getItem("receiptOpened") === "true";

          if (forceRestore) {
            // Restore basic fields (overwrite)
            if (orderState.customerId && custName) {
              const option = Array.from(custName.options).find(opt => opt.value === orderState.customerId);
              if (option) {
                custName.value = orderState.customerId;
                custName.dispatchEvent(new Event('change'));
              } else {
                // If customer not found, still clear selection
                custName.value = "";
              }
            }
            if (orderState.billNo && billNo) billNo.value = orderState.billNo;
            if (orderState.orderDate && orderDate) orderDate.value = orderState.orderDate;
            if (orderState.dueDate && dueDate) dueDate.value = orderState.dueDate;
            if (orderState.gstRate && gstRate) gstRate.value = orderState.gstRate;

            // Restore rows (overwrite): clear and rebuild exactly
            if (itemBody) itemBody.innerHTML = "";
            if (orderState.rows && orderState.rows.length > 0 && itemBody) {
              orderState.rows.forEach(rowData => {
                addRow();
                const tr = itemBody.lastElementChild;

                if (rowData.values && rowData.values.length > 0) {
                  tr.querySelectorAll("input,select").forEach((el, j) => {
                    if (rowData.values[j] !== undefined && rowData.values[j] !== null) {
                      el.value = rowData.values[j];
                    }
                  });
                }

                if (rowData.delivery || rowData.orderFilled) {
                  tr.dataset.delivery = rowData.delivery || "";
                  tr.dataset.sample = rowData.sample || "";
                  tr.dataset.orderFilled = rowData.orderFilled || "";
                }

                // Preserve saved total (column 13) after calc()
                const savedTotal = rowData.values && rowData.values.length > 13 ? (rowData.values[13] || "") : "";
                setTimeout(() => {
                  if (tr.cells[7] && tr.cells[7].children[0]) {
                    calc(tr.cells[7].children[0]);
                    if (savedTotal && tr.cells[13] && tr.cells[13].children[0]) {
                      tr.cells[13].children[0].value = savedTotal;
                    }
                  }
                }, 10);
              });
            } else {
              // Ensure at least one row
              addRow();
            }

            // Clear flags/state now that we restored
            localStorage.removeItem("newOrderState");
            localStorage.removeItem("ratebookOpened");
            localStorage.removeItem("receiptOpened");
            localStorage.removeItem("newOrderForceRestore");

            // Refresh panels (paid amount depends on billNo)
            setTimeout(() => {
              updateInfoPanel();
              applyPendingRatebook();
            }, 50);

            return;
          }

          // Check if we already have data in the form
          const existingRows = itemBody ? itemBody.querySelectorAll("tr").length : 0;
          const hasExistingData = existingRows > 0 && (
            (billNo && billNo.value) ||
            (custName && custName.value) ||
            (itemBody && itemBody.querySelectorAll("tr").some(tr => {
              const inputs = tr.querySelectorAll("input");
              return Array.from(inputs).some(inp => inp.value && inp.value.trim() !== "");
            }))
          );

          // Only restore if we don't have existing data, or if saved state has more data
          const shouldRestore = !hasExistingData || (orderState.rows && orderState.rows.length > existingRows);

          if (shouldRestore) {
            // Restore basic fields only if they're empty
            if (orderState.customerId && custName && !custName.value) {
              const option = Array.from(custName.options).find(opt => opt.value === orderState.customerId);
              if (option) {
                custName.value = orderState.customerId;
                custName.dispatchEvent(new Event('change'));
              }
            }
            if (orderState.billNo && billNo && !billNo.value) billNo.value = orderState.billNo;
            if (orderState.orderDate && orderDate && !orderDate.value) orderDate.value = orderState.orderDate;
            if (orderState.dueDate && dueDate && !dueDate.value) dueDate.value = orderState.dueDate;
            if (orderState.gstRate && gstRate && !gstRate.value) gstRate.value = orderState.gstRate;

            // Restore rows - MERGE with existing instead of replacing
            if (orderState.rows && orderState.rows.length > 0 && itemBody) {
              // If we have existing rows, check if we should add or update
              if (existingRows === 0) {
                // No existing rows, restore all saved rows
                orderState.rows.forEach(rowData => {
                  addRow();
                  const tr = itemBody.lastElementChild;

                  if (rowData.values && rowData.values.length > 0) {
                    tr.querySelectorAll("input,select").forEach((el, j) => {
                      if (rowData.values[j] !== undefined && rowData.values[j] !== null) {
                        el.value = rowData.values[j];
                      }
                    });
                  }

                  if (rowData.delivery || rowData.orderFilled) {
                    tr.dataset.delivery = rowData.delivery || "";
                    tr.dataset.sample = rowData.sample || "";
                    tr.dataset.orderFilled = rowData.orderFilled || "";
                  }

                  // Recalculate row
                  setTimeout(() => {
                    if (tr.cells[7] && tr.cells[7].children[0]) {
                      calc(tr.cells[7].children[0]);
                    }
                  }, 10);
                });
              } else {
                // We have existing rows - merge data instead of replacing
                // Update existing rows with saved data where applicable
                const existingTrs = itemBody.querySelectorAll("tr");
                orderState.rows.forEach((rowData, index) => {
                  if (index < existingTrs.length) {
                    // Update existing row
                    const tr = existingTrs[index];
                    if (rowData.values && rowData.values.length > 0) {
                      tr.querySelectorAll("input,select").forEach((el, j) => {
                        // Only update if current value is empty and saved value exists
                        if (!el.value || el.value.trim() === "") {
                          if (rowData.values[j] !== undefined && rowData.values[j] !== null && rowData.values[j] !== "") {
                            el.value = rowData.values[j];
                          }
                        }
                      });
                    }

                    if (rowData.delivery || rowData.orderFilled) {
                      if (!tr.dataset.delivery) tr.dataset.delivery = rowData.delivery || "";
                      if (!tr.dataset.sample) tr.dataset.sample = rowData.sample || "";
                      if (!tr.dataset.orderFilled) tr.dataset.orderFilled = rowData.orderFilled || "";
                    }

                    // Recalculate row
                    setTimeout(() => {
                      if (tr.cells[7] && tr.cells[7].children[0]) {
                        calc(tr.cells[7].children[0]);
                      }
                    }, 10);
                  } else {
                    // Add new row for additional saved data
                    addRow();
                    const tr = itemBody.lastElementChild;

                    if (rowData.values && rowData.values.length > 0) {
                      tr.querySelectorAll("input,select").forEach((el, j) => {
                        if (rowData.values[j] !== undefined && rowData.values[j] !== null) {
                          el.value = rowData.values[j];
                        }
                      });
                    }

                    if (rowData.delivery || rowData.orderFilled) {
                      tr.dataset.delivery = rowData.delivery || "";
                      tr.dataset.sample = rowData.sample || "";
                      tr.dataset.orderFilled = rowData.orderFilled || "";
                    }

                    // Recalculate row
                    setTimeout(() => {
                      if (tr.cells[7] && tr.cells[7].children[0]) {
                        calc(tr.cells[7].children[0]);
                      }
                    }, 10);
                  }
                });
              }
            } else if (itemBody && itemBody.querySelectorAll("tr").length === 0) {
              // If no rows saved and no existing rows, add one empty row
              addRow();
            }
          } else {
            // We have existing data and it's more complete - keep it as is
            console.log("Preserving existing form data");
          }

          // Clear saved state after restoring (or deciding not to restore)
          localStorage.removeItem("newOrderState");
          // Clear return flags as well (prevents repeated restore attempts)
          localStorage.removeItem("ratebookOpened");
          localStorage.removeItem("receiptOpened");

          // Update panel after restoring
          updateInfoPanel();
          applyPendingRatebook();
        }, 100);
      } catch (e) {
        console.error("Error restoring order state:", e);
        // Clear saved state on error, but preserve existing data
        localStorage.removeItem("newOrderState");
        // Make sure we have at least one row
        if (itemBody && itemBody.querySelectorAll("tr").length === 0) {
          addRow();
        }
      }
    }

    /* APPLY RATE SELECTED IN ratebook.html (workspace flow) */
    function applyPendingRatebook() {
      try {
        const rateIdStr = localStorage.getItem("ratebookApplyRateId");
        if (!rateIdStr) return;

        const rateId = Number(rateIdStr);
        localStorage.removeItem("ratebookApplyRateId");

        // Try to apply to a specific row if provided
        const idx = Number(localStorage.getItem("ratebookTargetRowIndex") || "-1");
        localStorage.removeItem("ratebookTargetRowIndex");

        const rates = JSON.parse(localStorage.getItem("rateBook") || "[]");
        const rate = rates.find(r => Number(r.id) === Number(rateId));

        if (rate && itemBody) {
          const trs = Array.from(itemBody.querySelectorAll("tr"));
          const tr = idx >= 0 && idx < trs.length ? trs[idx] : null;
          if (tr) {
            const rateInput = tr.cells[11] && tr.cells[11].children[0];
            const stampInput = tr.cells[3] && tr.cells[3].children[0];
            if (rateInput) {
              rateInput.value = rate.rate;
              if (stampInput && rate.stamp) stampInput.value = rate.stamp;
              calc(rateInput);
              setTimeout(() => updateRatebookPanel(), 100);
              return;
            }
          }
        }

        // Fallback: use existing logic
        if (typeof applyRateToRow === "function") {
          applyRateToRow(rateId);
        }
      } catch (e) {
        console.error("Error applying pending ratebook rate:", e);
      }
    }

    function closeRateBookPopup() {
      // Compatibility function - does nothing since popup removed
      activeRateRow = null;
      localStorage.removeItem("activeRateRow");
    }

    function calculateRateAmount() {
      // This logic is now in ratebook.html - kept for compatibility
      // The same calculation logic exists in ratebook.html's calcAmount() function
    }

    function saveRateBook() {
      // This logic is now in ratebook.html - kept for compatibility
      // The same save logic exists in ratebook.html's saveRate() function
    }

    function loadRateBookHistory() {
      // This logic can be used by ratebook.html if needed - kept for compatibility
      // Returns the rate history data
      const rates = JSON.parse(localStorage.getItem("rateBook") || "[]");

      // Sort by date (newest first)
      return [...rates].sort((a, b) => {
        const dateA = new Date(a.timestamp || a.date || 0);
        const dateB = new Date(b.timestamp || b.date || 0);
        return dateB - dateA;
      });
    }

    function applyRateToRow(rateId) {
      // Same logic as before - applies rate to order row
      const rates = JSON.parse(localStorage.getItem("rateBook") || "[]");
      const rate = rates.find(r => r.id === rateId);

      if (!rate) {
        alert("Rate not found");
        return;
      }

      // Initialize elements if needed
      if (!itemBody) {
        if (!initElements()) {
          alert("Order form not initialized");
          return;
        }
      }

      // Try to apply to first row with empty rate, or first row
      const rows = itemBody.querySelectorAll("tr");
      let applied = false;

      for (let row of rows) {
        const rateInput = row.cells[11] && row.cells[11].children[0];
        if (rateInput) {
          // Apply to first empty rate field, or first row
          if (!rateInput.value || rateInput.value === "0" || rateInput.value === "" || !applied) {
            rateInput.value = rate.rate;
            // Trigger calculation
            calc(rateInput);

            // Optionally apply stamp to Stamp column (column index 3)
            const stampInput = row.cells[3] && row.cells[3].children[0];
            if (stampInput && rate.stamp) {
              stampInput.value = rate.stamp;
            }

            alert(`Rate ‚Çπ${rate.rate} applied to row`);
            applied = true;
            // Update ratebook panel to show applied rate
            setTimeout(() => {
              updateRatebookPanel();
            }, 100);
            break;
          }
        }
      }

      if (!applied && rows.length > 0) {
        // Apply to first row anyway
        const firstRow = rows[0];
        const rateInput = firstRow.cells[11] && firstRow.cells[11].children[0];
        if (rateInput) {
          rateInput.value = rate.rate;
          calc(rateInput);

          const stampInput = firstRow.cells[3] && firstRow.cells[3].children[0];
          if (stampInput && rate.stamp) {
            stampInput.value = rate.stamp;
          }

          alert(`Rate ‚Çπ${rate.rate} applied to first row`);
          // Update ratebook panel to show applied rate
          setTimeout(() => {
            updateRatebookPanel();
          }, 100);
        }
      }

      // Close ratebook window if opened from parent
      if (window.opener) {
        try {
          window.opener.focus();
        } catch (e) { }
      }
    }

    /* =====================
       PANEL UPDATE FUNCTIONS
    ===================== */
    function updateInfoPanel() {
      updatePaymentPanel();
      updateRatebookPanel();
      updateReceiptPanel();
    }

    function updatePaymentPanel() {
      if (!billNo || !billNo.value) return;

      // Calculate Breakdown
      let orderTotal = 0;
      let purchaseTotal = 0;

      if (itemBody) {
        itemBody.querySelectorAll("tr").forEach(r => {
          if (r.cells[13] && r.cells[13].children[0]) {
            const t = +r.cells[13].children[0].value || 0;
            const typeSelect = r.cells[0] && r.cells[0].querySelector("select");
            const type = typeSelect ? typeSelect.value : "Order";

            if (type === "Purchase") {
              purchaseTotal += t;
            } else {
              orderTotal += t;
            }
          }
        });
      }

      const netTotal = orderTotal - purchaseTotal;
      const paid = getPaidAmount(billNo.value);
      const balance = netTotal - paid;

      const orderTotalEl = document.getElementById("panelOrderTotal");
      const purchaseTotalEl = document.getElementById("panelPurchaseTotal");
      const billTotalEl = document.getElementById("panelBillTotal");
      const paidEl = document.getElementById("panelPaid");
      const balanceEl = document.getElementById("panelBalance");
      const paymentListEl = document.getElementById("paymentList");

      if (orderTotalEl) orderTotalEl.textContent = `‚Çπ ${orderTotal.toFixed(2)}`;
      if (purchaseTotalEl) purchaseTotalEl.textContent = `‚Çπ ${purchaseTotal.toFixed(2)}`;
      if (billTotalEl) billTotalEl.textContent = `‚Çπ ${netTotal.toFixed(2)}`;
      if (paidEl) paidEl.textContent = `‚Çπ ${paid.toFixed(2)}`;
      if (balanceEl) balanceEl.textContent = `‚Çπ ${balance.toFixed(2)}`;

      // Get payments for this bill
      const payments = JSON.parse(localStorage.getItem("payments") || "[]");
      const billPayments = payments.filter(p => p.billNo === billNo.value);

      if (paymentListEl) {
        if (billPayments.length === 0) {
          paymentListEl.innerHTML = '<div class="empty-state">No payments yet</div>';
        } else {
          let html = '';
          billPayments.slice(-5).reverse().forEach(p => {
            const date = p.date ? new Date(p.date).toLocaleDateString() : '‚Äî';
            const narration = (p.narration || '‚Äî').substring(0, 30);
            html += `
          <div class="panel-item">
            <div class="panel-item-header">
              <span>‚Çπ ${(Number(p.amount) || 0).toFixed(2)}</span>
              <span>${p.mode || 'Cash'}</span>
            </div>
            <div class="panel-item-detail">${date} - ${narration}</div>
          </div>
        `;
          });
          paymentListEl.innerHTML = html;
        }
      }
    }

    function updateRatebookPanel() {
      const ratebookListEl = document.getElementById("ratebookList");
      if (!ratebookListEl) return;

      // Only show rates that are actually applied/used in the current order
      const appliedRates = [];
      if (itemBody) {
        itemBody.querySelectorAll("tr").forEach(tr => {
          const rateInput = tr.cells[11] && tr.cells[11].children[0];
          if (rateInput && rateInput.value && parseFloat(rateInput.value) > 0) {
            const stampInput = tr.cells[3] && tr.cells[3].children[0];
            const itemNameInput = tr.cells[2] && tr.cells[2].children[0];
            const weightInput = tr.cells[10] && tr.cells[10].children[0];

            // Create a unique key for this rate combination
            const rateKey = `${rateInput.value}_${stampInput ? stampInput.value : ''}_${itemNameInput ? itemNameInput.value : ''}`;

            // Check if we already added this rate
            const exists = appliedRates.some(r => r.key === rateKey);
            if (!exists) {
              appliedRates.push({
                key: rateKey,
                rate: rateInput.value,
                stamp: stampInput ? stampInput.value : "",
                itemName: itemNameInput ? itemNameInput.value : "",
                weight: weightInput ? weightInput.value : "",
                date: new Date().toLocaleDateString()
              });
            }
          }
        });
      }

      if (appliedRates.length === 0) {
        ratebookListEl.innerHTML = '<div class="empty-state">No rates applied to this order</div>';
      } else {
        let html = '';
        appliedRates.forEach(r => {
          const itemName = (r.itemName || '‚Äî').substring(0, 25);
          html += `
        <div class="panel-item">
          <div class="panel-item-header">
            <span>‚Çπ ${(Number(r.rate) || 0).toFixed(2)}</span>
            <span>${r.stamp || '‚Äî'}</span>
          </div>
          <div class="panel-item-detail">${itemName}${r.weight ? ' - Wt: ' + r.weight : ''}</div>
        </div>
      `;
        });
        ratebookListEl.innerHTML = html;
      }
    }

    function updateReceiptPanel() {
      const receiptListEl = document.getElementById("receiptList");
      if (!receiptListEl) return;

      // Get ALL receipts (from receipts storage, not payments)
      const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");
      const customerName = getCustomerName();

      // Filter receipts: show receipts for current bill if available, otherwise show recent receipts
      let displayReceipts = [];

      if (billNo && billNo.value) {
        // Show receipts for this bill first
        const billReceipts = receipts.filter(r => r.billNo === billNo.value);
        // Also show recent receipts without billNo (last 3) if bill receipts exist
        if (billReceipts.length > 0) {
          const recentNoBill = receipts
            .filter(r => !r.billNo || r.billNo === "")
            .sort((a, b) => {
              const dateA = new Date(a.timestamp || a.date || 0);
              const dateB = new Date(b.timestamp || b.date || 0);
              return dateB - dateA;
            })
            .slice(0, 3);
          displayReceipts = [...billReceipts, ...recentNoBill];
        } else {
          // No bill receipts, show recent receipts (last 5)
          displayReceipts = receipts
            .sort((a, b) => {
              const dateA = new Date(a.timestamp || a.date || 0);
              const dateB = new Date(b.timestamp || b.date || 0);
              return dateB - dateA;
            })
            .slice(0, 5);
        }
      } else {
        // No bill number - show most recent receipts (last 5)
        displayReceipts = receipts
          .sort((a, b) => {
            const dateA = new Date(a.timestamp || a.date || 0);
            const dateB = new Date(b.timestamp || b.date || 0);
            return dateB - dateA;
          })
          .slice(0, 5);
      }

      // Remove duplicates
      const uniqueReceipts = [];
      const seenIds = new Set();
      displayReceipts.forEach(r => {
        if (r.id && !seenIds.has(r.id)) {
          seenIds.add(r.id);
          uniqueReceipts.push(r);
        } else if (!r.id) {
          const uniqueKey = `${r.timestamp || r.date || ''}_${r.amount}_${r.customer || ''}_${r.billNo || ''}`;
          if (!seenIds.has(uniqueKey)) {
            seenIds.add(uniqueKey);
            uniqueReceipts.push(r);
          }
        }
      });
      displayReceipts = uniqueReceipts;

      if (displayReceipts.length === 0) {
        receiptListEl.innerHTML = '<div class="empty-state">No receipts available</div>';
      } else {
        // Sort by date (newest first)
        const sortedReceipts = [...displayReceipts].sort((a, b) => {
          const dateA = new Date(a.timestamp || a.date || 0);
          const dateB = new Date(b.timestamp || b.date || 0);
          return dateB - dateA;
        });

        let html = '';
        sortedReceipts.forEach(r => {
          const date = r.date ? new Date(r.date).toLocaleDateString() : (r.timestamp ? new Date(r.timestamp).toLocaleDateString() : '‚Äî');
          let narration = r.narration || "";
          // Add additional fields to narration if they exist
          const extraInfo = [];
          if (r.batch) extraInfo.push(`Batch: ${r.batch}`);
          if (r.expDate) extraInfo.push(`Exp: ${r.expDate}`);
          if (r.apCode) extraInfo.push(`Code: ${r.apCode}`);
          if (extraInfo.length > 0) {
            narration = narration ? `${narration} | ${extraInfo.join(', ')}` : extraInfo.join(', ');
          }
          narration = narration.substring(0, 30);

          html += `
        <div class="panel-item" style="position:relative;" data-receipt-id="${r.id || ''}" data-receipt-timestamp="${r.timestamp || r.date || ''}">
          <div class="panel-item-header">
            <span>‚Çπ ${(Number(r.amount) || 0).toFixed(2)}</span>
            <span>${r.mode || 'Cash'}</span>
            <button class="delete-receipt-panel-btn" style="background:#ff3b30; color:#fff; border:none; padding:2px 6px; border-radius:4px; cursor:pointer; font-size:10px; margin-left:auto;">‚ùå</button>
          </div>
          <div class="panel-item-detail">${date} - ${narration || '‚Äî'}</div>
        </div>
      `;
        });
        receiptListEl.innerHTML = html;

        // Add click handlers to all delete buttons in panel
        receiptListEl.querySelectorAll('.delete-receipt-panel-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            const panelItem = this.closest('.panel-item');
            if (panelItem) {
              const receiptId = panelItem.dataset.receiptId ? Number(panelItem.dataset.receiptId) : null;
              const timestamp = panelItem.dataset.receiptTimestamp || '';
              deleteReceipt(receiptId, timestamp);
            }
          });
        });
      }
    }

    /* =====================
       DELETE RECEIPT
    ===================== */
    function deleteReceipt(receiptId, timestamp) {
      if (!confirm("Are you sure you want to delete this receipt?")) {
        return;
      }

      const receipts = JSON.parse(localStorage.getItem("receipts") || "[]");

      // Find and remove the receipt
      let receiptFound = false;
      let deletedReceipt = null;

      const updatedReceipts = receipts.filter(r => {
        // Try to match by ID first
        if (receiptId && receiptId !== 'null' && receiptId !== null && r.id) {
          const idMatch = Number(r.id) === Number(receiptId) || String(r.id) === String(receiptId);
          if (idMatch) {
            receiptFound = true;
            deletedReceipt = r;
            return false; // Remove this receipt
          }
        }
        // Match by timestamp (for receipts without ID or as fallback)
        if (timestamp && timestamp !== '') {
          const rTimestamp = r.timestamp || r.date || '';
          if (rTimestamp === timestamp) {
            receiptFound = true;
            deletedReceipt = r;
            return false; // Remove this receipt
          }
        }
        return true; // Keep this receipt
      });

      if (receiptFound && deletedReceipt) {
        localStorage.setItem("receipts", JSON.stringify(updatedReceipts));

        // Also remove from bills if linked
        if (deletedReceipt.id) {
          const bills = JSON.parse(localStorage.getItem("bills") || "[]");
          bills.forEach(bill => {
            if (bill.receipts && Array.isArray(bill.receipts)) {
              bill.receipts = bill.receipts.filter(rid => {
                return rid !== deletedReceipt.id;
              });
            }
          });
          localStorage.setItem("bills", JSON.stringify(bills));
        }

        // Update displays
        setTimeout(() => {
          updateReceiptPanel();
          updateInfoPanel();

          // If invoice is open, refresh receipt table
          if (invoice && invoice.style.display !== 'none') {
            refreshInvoiceReceiptTable();
          }
        }, 100);

        alert("Receipt deleted successfully");
      } else {
        alert("Receipt not found");
      }
    }

    /* =====================
       ENSURE FUNCTIONS ARE GLOBALLY ACCESSIBLE
       (For onclick handlers and dashboard integration)
    ===================== */
    function ensureFunctionsGlobal() {
      // Make all functions available globally
      window.loadCustomers = loadCustomers;
      window.addRow = addRow;
      window.calc = calc;
      window.saveOrder = saveOrder;
      window.saveAndNew = saveAndNew;
      window.resetOrder = resetOrder;
      window.showInvoice = showInvoice;
      window.back = back;
      window.openPayment = openPayment;
      window.openCustomer = openCustomer;
      window.openReceipt = openReceipt;
      window.openRateBook = openRateBook;
      window.setCustomerName = setCustomerName;
      window.getCustomerName = getCustomerName;
      window.loadOrderForEdit = loadOrderForEdit;
      window.loadBill = loadBill;
      window.handleTypeChange = handleTypeChange;
      window.calculateDeliveryDate = calculateDeliveryDate;
      window.saveOrderPopup = saveOrderPopup;
      window.closePopup = closePopup;
      window.calculatePaymentBalance = calculatePaymentBalance;
      window.closePaymentPopup = closePaymentPopup;
      window.savePaymentFromPopup = savePaymentFromPopup;
      window.saveRateBook = saveRateBook;
      window.closeRateBookPopup = closeRateBookPopup;
      window.calculateRateAmount = calculateRateAmount;
      window.loadRateBookHistory = loadRateBookHistory;
      window.applyRateToRow = applyRateToRow;
      window.initOrderPage = initOrderPage;
      window.initElements = initElements;
      window.saveOrderState = saveOrderState;
      window.restoreOrderState = restoreOrderState;
      window.generateBillNo = generateBillNo;
      window.generateJobNo = generateJobNo;
      window.calculateBillTotal = calculateBillTotal;
      window.getPaidAmount = getPaidAmount;
      window.updateInfoPanel = updateInfoPanel;
      window.updatePaymentPanel = updatePaymentPanel;
      window.updateRatebookPanel = updateRatebookPanel;
      window.updateReceiptPanel = updateReceiptPanel;
      window.refreshInvoiceReceiptTable = refreshInvoiceReceiptTable;
      window.deleteReceipt = deleteReceipt;
      window.closeDashboard = closeDashboard;
    }

    function closeDashboard() {
      // Reset form data before closing
      if (typeof resetOrder === 'function') {
        resetOrder(true);
      }

      if (typeof loadPage === 'function') {
        loadPage('dashboard.html');
      } else if (window.parent && typeof window.parent.loadPage === 'function') {
        window.parent.loadPage('dashboard.html');
      } else {
        // Fallback to index if no loadPage system
        window.location.href = '../index.html';
      }
    }

    // Make functions globally accessible immediately
    ensureFunctionsGlobal();




  </script>

</body>

</html>