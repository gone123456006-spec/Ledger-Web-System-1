<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Order</title>

<style>
/* =====================================================
   FULLY RESPONSIVE APPLE-STYLE ERP UI – NEW ORDER
===================================================== */

:root{
  --bg:#eef2f7;
  --card:#ffffff;
  --text:#1d1d1f;
  --muted:#6e6e73;
  --border:#d1d1d6;
  --primary:#007aff;
  --primary-soft:rgba(0,122,255,.14);
  --danger:#ff3b30;
  --radius:14px;
  --shadow-lg:0 24px 48px rgba(0,0,0,.18);
  --shadow-sm:0 6px 14px rgba(0,0,0,.08);
}

/* RESET */
*{
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,
              "Segoe UI",Roboto,Arial,sans-serif;
}

body{
  margin:0;
  background:
    radial-gradient(circle at top,#f5f7fb,#e6ebf3 60%);
  color:var(--text);
}

/* ===============================
   CONTAINER
================================ */
.order-window{
  max-width:1400px;
  margin:auto;
  padding:16px;
}

/* ===============================
   HEADER
================================ */
.order-title{
  font-size:18px;
  font-weight:600;
  margin-bottom:16px;
}

/* ===============================
   TOP GRID (DESKTOP)
================================ */
.order-top{
  display:grid;
  grid-template-columns:1fr 340px;
  gap:16px;
}

/* ===============================
   CARDS
================================ */
.box{
  background:var(--card);
  border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:var(--shadow-sm);
  padding:16px;
}

.box-title{
  font-size:15px;
  font-weight:600;
  margin-bottom:12px;
  color:var(--muted);
}

/* ===============================
   FORM ROWS
================================ */
.row{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}

.row label{
  min-width:110px;
  font-size:13px;
  color:var(--muted);
}

.row input,
.row select{
  flex:1;
  height:36px;
  padding:6px 10px;
  border-radius:10px;
  border:1px solid var(--border);
  font-size:14px;
  background:#fff;
  transition:.2s;
}

.row input:focus,
.row select:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 4px var(--primary-soft);
}

.row input[readonly]{
  background:#f5f5f7;
}

/* ===============================
   TABLE
================================ */
.order-details{
  margin-top:18px;
}

.table-wrap{
  background:var(--card);
  border-radius:var(--radius);
  border:1px solid var(--border);
  box-shadow:var(--shadow-lg);
  overflow-x:auto;            /* MOBILE SAFE */
}

table{
  width:100%;
  min-width:900px;            /* prevents column collapse */
  border-collapse:separate;
  border-spacing:0;
  font-size:13.5px;
}

thead th{
  position:sticky;
  top:0;
  background:#f5f6fa;
  z-index:2;
}

th,td{
  padding:8px 10px;
  border-bottom:1px solid var(--border);
  white-space:nowrap;
}

tbody tr:hover{
  background:#f8faff;
}

td input,
td select{
  width:100%;
  height:30px;
  border-radius:8px;
  border:1px solid var(--border);
  padding:4px 6px;
}

/* ===============================
   FOOTER
================================ */
.order-footer{
  margin-top:18px;
  display:flex;
  justify-content:flex-end;
  gap:12px;
  flex-wrap:wrap;             /* MOBILE SAFE */
}

.order-footer button{
  min-width:96px;
  height:38px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-size:14px;
  cursor:pointer;
}

/* PRIMARY */
.order-footer button:first-child{
  background:var(--primary);
  border-color:var(--primary);
  color:#fff;
  font-weight:600;
}

/* PRINT */
.order-footer button:nth-child(2){
  background:#eaf2ff;
  border-color:#c9dcff;
}

/* CANCEL */
.order-footer button:last-child{
  background:#ffecec;
  border-color:#ffb5b5;
  color:#7f0000;
}

/* ===============================
   ANIMATION
================================ */
.box,
.table-wrap{
  animation:fadeIn .35s ease;
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(8px)}
  to{opacity:1;transform:none}
}

/* ===============================
   TABLET (≤ 1024px)
================================ */
@media(max-width:1024px){
  .order-top{
    grid-template-columns:1fr;
  }
}

/* ===============================
   MOBILE (≤ 600px)
================================ */
@media(max-width:600px){

  .order-window{
    padding:12px;
  }

  .order-title{
    font-size:16px;
  }

  .row{
    flex-direction:column;
    align-items:flex-start;
  }

  .row label{
    min-width:100%;
  }

  .row input,
  .row select{
    width:100%;
    height:40px;
  }

  table{
    font-size:13px;
  }

  .order-footer{
    justify-content:center;
  }

  .order-footer button{
    width:100%;
    max-width:260px;
  }
}

.adv-btn{
  width:100%;
  height:30px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#eef4ff;
  color:#003a8f;
  font-size:13px;
  cursor:pointer;
}
.adv-btn:hover{
  background:#dce9ff;
}







/* ===============================
   ADVANCE MODAL
================================ */
#advModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  align-items:center;
  justify-content:center;
  z-index:10000;
}

.adv-modal-content{
  background:#fff;
  border-radius:16px;
  box-shadow:0 25px 45px rgba(0,0,0,.3);
  max-width:500px;
  width:90%;
  max-height:90vh;
  overflow-y:auto;
}

.adv-modal-header{
  background:linear-gradient(#f4f6fa,#e6eaf0);
  padding:15px 20px;
  font-weight:600;
  font-size:16px;
  border-bottom:1px solid #d1d6de;
  border-radius:16px 16px 0 0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.adv-modal-close{
  background:none;
  border:none;
  font-size:24px;
  cursor:pointer;
  color:#666;
  padding:0;
  width:30px;
  height:30px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.adv-modal-close:hover{
  color:#000;
}

.adv-modal-body{
  padding:25px;
}

.adv-form-row{
  margin-bottom:18px;
}

.adv-form-row label{
  display:block;
  font-size:14px;
  font-weight:600;
  margin-bottom:8px;
  color:#333;
}

.adv-form-row input,
.adv-form-row textarea{
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #d1d6de;
  font-size:14px;
  font-family:inherit;
}

.adv-form-row textarea{
  height:100px;
  resize:vertical;
}

.adv-form-row input:focus,
.adv-form-row textarea:focus{
  outline:none;
  border-color:#007aff;
  box-shadow:0 0 0 3px rgba(0,122,255,.15);
}

.adv-modal-footer{
  padding:15px 25px;
  border-top:1px solid #d1d6de;
  display:flex;
  justify-content:flex-end;
  gap:12px;
  border-radius:0 0 16px 16px;
}

.adv-modal-footer button{
  padding:10px 20px;
  border-radius:10px;
  border:1px solid #d1d6de;
  font-size:14px;
  cursor:pointer;
  font-weight:500;
}

.adv-btn-save{
  background:#007aff;
  color:#fff;
  border-color:#007aff;
}

.adv-btn-save:hover{
  background:#0056b3;
}

.adv-btn-cancel{
  background:#fff;
  color:#333;
}

.adv-btn-cancel:hover{
  background:#f5f5f5;
}

/* ===============================
   PRINT (A4) - BILL FORMAT
================================ */
@media print{
  body{
    background:#fff;
    margin:0;
    padding:0;
  }
  
  .no-print{
    display:none!important;
  }
  
  .order-window{
    max-width:100%;
    padding:0;
    margin:0;
  }
  
  .order-title{
    font-size:24px;
    font-weight:700;
    text-align:center;
    margin-bottom:20px;
    border-bottom:3px solid #000;
    padding-bottom:10px;
  }
  
  .order-top{
    display:block;
    margin-bottom:25px;
  }
  
  .box{
    box-shadow:none;
    border:1px solid #000;
    border-radius:0;
    padding:15px;
    margin-bottom:15px;
    page-break-inside:avoid;
  }
  
  .box-title{
    font-size:16px;
    font-weight:700;
    margin-bottom:12px;
    border-bottom:2px solid #000;
    padding-bottom:5px;
  }
  
  .row{
    margin-bottom:8px;
  }
  
  .row label{
    font-weight:600;
    min-width:140px;
  }
  
  .row input,
  .row select{
    border:1px solid #000;
    border-radius:0;
    padding:4px 8px;
  }
  
  .order-details{
    margin-top:20px;
  }
  
  .table-wrap{
    box-shadow:none;
    border:2px solid #000;
    border-radius:0;
    overflow:visible;
  }
  
  table{
    border-collapse:collapse;
    width:100%;
    font-size:12px;
  }
  
  thead th{
    background:#f0f0f0!important;
    border:1px solid #000;
    padding:10px 8px;
    font-weight:700;
    text-align:left;
  }
  
  tbody td{
    border:1px solid #000;
    padding:8px;
  }
  
  tbody td input,
  tbody td select{
    border:none;
    background:transparent;
    width:100%;
    padding:0;
  }
  
  /* Advance details in print */
  .adv-details-print{
    display:none;
  }
  
  tr[data-adv-data]:not([data-adv-data=""]) .adv-details-print{
    display:block;
    font-size:10px;
    color:#555;
    margin-top:4px;
    font-style:italic;
  }
  
  /* Bill summary */
  .bill-summary{
    margin-top:25px;
    border:2px solid #000;
    padding:15px;
    page-break-inside:avoid;
  }
  
  .summary-row{
    display:flex;
    justify-content:space-between;
    padding:8px 0;
    border-bottom:1px solid #ccc;
    font-size:14px;
  }
  
  .summary-row:last-child{
    border-bottom:2px solid #000;
    font-weight:700;
    font-size:16px;
    margin-top:5px;
    padding-top:10px;
  }
  
  @page{
    size:A4;
    margin:15mm;
  }
}
</style>

</head>

<body>

<div class="order-window" id="order-window">

  <div class="order-title">New Order</div>

  <!-- TOP -->
  <div class="order-top">

    <!-- CUSTOMER -->
    <div class="box">
      <div class="box-title">Customer Information</div>

      <div class="row">
        <label>Name *</label>
        <select id="custName"></select>
      </div>

      <div class="row">
        <label>Current Bal</label>
        <input id="currentBal" readonly>
      </div>

      <div class="row">
        <label>Relation</label>
        <input id="relation" readonly>
      </div>

      <div class="row">
        <label>Station</label>
        <input id="station" readonly>
      </div>


      <div class="row">
        <label>Gold Purity</label>
        <select id="goldRate">
          <option value="6200">22 CR Gold</option>
          <option value="6800">24 CR Gold</option>
          <option value="5900">21 CR Gold</option>
          <option value="5400">19 CR Gold</option>
        </select>
      </div>
      
      <div class="row">
        <label>Silver Purity</label>
        <select id="silverRate">
          <option value="75">Fine Silver</option>
          <option value="72">Sterling Silver</option>
          <option value="68">800 Silver</option>
          <option value="60">700 Silver</option>
        </select>
      </div>



      <div class="row">
        <button onclick="openCustomer()" class="no-print">
          + Add / Edit Customer
        </button>
      </div>
    </div>

    <!-- BILL -->
    <div class="box">
      <div class="box-title">Bill Information</div>

      <div class="row">
        <label>Bill No</label>
        <input id="billNo">
      </div>

      <div class="row">
        <label>Date</label>
        <input type="date" id="billDate">
      </div>
      <div class="row">
        <label> Due Date</label>
        <input type="date" id="dueDate">
      </div>

      <div class="row">
        <label>GST %</label>
        <input id="gstRate" value="3">
      </div>
    </div>

  </div>

  <!-- DETAILS -->
  <div class="order-details">
    <div class="box-title">Order Details</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Qty</th>
            <th>Item</th>
            <th>Metal</th>
            <th>Est Unit Wt</th>
            <th>Total Wt</th>
            <th>Mark %</th>
            <th>GST</th>
            <th>Total Amt</th>
            <th>Adv</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="order-footer no-print">
    <button onclick="saveOrder()">Save</button>
<button onclick="saveAndNew()">Save & New</button>
    <button onclick="printBill()">Print</button>
<button onclick="cancelOrder()">Cancel</button>
  </div>

</div>

<!-- ADVANCE PAYMENT MODAL -->
<div id="advModal" class="no-print">
  <div class="adv-modal-content">
    <div class="adv-modal-header">
      <span>ADVANCE PAYMENT</span>
      <button class="adv-modal-close" onclick="closeAdvModal()">&times;</button>
    </div>
    <div class="adv-modal-body">
      <div class="adv-form-row">
        <label>Date</label>
        <input type="date" id="advPayDate">
      </div>
      <div class="adv-form-row">
        <label>Advance Amount</label>
        <input type="number" id="advAmount" placeholder="0.00" step="0.01">
      </div>
      <div class="adv-form-row">
        <label>Description</label>
        <textarea id="advDescription" placeholder="Advance received for order"></textarea>
      </div>
    </div>
    <div class="adv-modal-footer">
      <button class="adv-btn-cancel" onclick="closeAdvModal()">Cancel</button>
      <button class="adv-btn-save" onclick="saveAdvance()">Save</button>
    </div>
  </div>
</div>

<script>
/* ===============================
   CONFIG
================================ */
const ROLE = localStorage.role || "staff";

const RATES = {
  Gold: 6200,
  Silver: 75
};

/* ===============================
  ELEMENTS + INIT
================================ */
const custName = document.getElementById('custName');
const currentBal = document.getElementById('currentBal');
const relation = document.getElementById('relation');
const station = document.getElementById('station');
const billNo = document.getElementById('billNo');
const billDate = document.getElementById('billDate');
const gstRate = document.getElementById('gstRate');
const rows = document.getElementById('rows');

function initNewOrder(){
  billDate.value = new Date().toISOString().split("T")[0];
  loadCustomers();
  
  // Check if editing an existing order
  const editOrderId = localStorage.getItem("editOrderId");
  if(editOrderId){
    // Wait a bit for DOM to be fully ready, then load order
    setTimeout(() => {
      loadOrderForEdit(editOrderId);
    }, 100);
  } else {
    addRow();
  }
}

// If this page is loaded directly the DOMContentLoaded event will fire;
// when the page is injected via fetch into the dashboard the event
// already happened, so call init immediately in that case.
if (document.readyState === 'loading') {
  window.addEventListener('DOMContentLoaded', initNewOrder);
} else {
  initNewOrder();
}

/* ===============================
   CUSTOMER AUTOFILL
================================ */
function loadCustomers(){
  const list = JSON.parse(localStorage.getItem("customers")||"[]");
  custName.innerHTML = `<option value="">-- Select --</option>`;
  list.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id;
    o.textContent=c.name;
    o.dataset.data=JSON.stringify(c);
    custName.appendChild(o);
  });
}

custName.onchange=()=>{
  const o=custName.selectedOptions[0];
  if(!o||!o.dataset.data)return;
  const c=JSON.parse(o.dataset.data);
  currentBal.value=c.openingBalance||0;
  relation.value=(c.relation||"")+" "+(c.relationName||"");
  station.value=c.station||"";
};

/* ===============================
   ROW HANDLING
================================ */
function addRow(){
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td><input class="qty" value="1"></td>
    <td>
      <input class="item">
      <div class="adv-details-print"></div>
    </td>
    <td>
      <select class="metal">
        <option>Gold</option>
        <option>Silver</option>
      </select>
    </td>
    <td><input class="unit"></td>
    <td><input class="after" readonly></td>
    <td><input class="mark" value="0"></td>
    <td><input class="gst" readonly></td>
    <td><input class="total" readonly></td>
    <td>
      <button type="button" class="adv-btn" onclick="openAdvPopup(this)">Adv</button>
    </td>
  `;
  
  // Initialize row data
  tr.dataset.advData = '';

  rows.appendChild(tr);

  tr.querySelectorAll("input,select").forEach(el=>{
    el.addEventListener("input", ()=>{
      calc(tr);
      autoExtendRow(tr);
    });
    el.addEventListener("keydown", e => nav(e,tr));
  });

  calc(tr);
  return tr;
}



// Store current row for advance modal
let currentAdvRow = null;

function openAdvPopup(btn){
  currentAdvRow = btn.closest('tr');
  const modal = document.getElementById('advModal');
  const advData = currentAdvRow.dataset.advData ? JSON.parse(currentAdvRow.dataset.advData) : {};
  
  // Populate form with existing data if any
  document.getElementById('advPayDate').value = advData.date || new Date().toISOString().split("T")[0];
  document.getElementById('advAmount').value = advData.amount || '';
  document.getElementById('advDescription').value = advData.description || '';
  
  modal.style.display = 'flex';
}

function closeAdvModal(){
  document.getElementById('advModal').style.display = 'none';
  currentAdvRow = null;
}

function saveAdvance(){
  if(!currentAdvRow) return;
  
  const amount = parseFloat(document.getElementById('advAmount').value) || 0;
  if(!amount){
    alert("Enter advance amount");
    return;
  }

  const advData = {
    date: document.getElementById('advPayDate').value,
    amount: amount,
    description: document.getElementById('advDescription').value.trim()
  };

  // Store in row data attribute
  currentAdvRow.dataset.advData = JSON.stringify(advData);
  
  // Update button to show it has advance
  const btn = currentAdvRow.querySelector('.adv-btn');
  btn.textContent = 'Adv ✓';
  btn.style.background = '#d4edda';
  btn.style.color = '#155724';
  
  // Update print display
  const advPrint = currentAdvRow.querySelector('.adv-details-print');
  if(advPrint){
    advPrint.textContent = `Adv: ₹${amount.toFixed(2)} on ${new Date(advData.date).toLocaleDateString()}`;
  }
  
  closeAdvModal();
}


function isRowComplete(tr){
  const qty  = tr.querySelector(".qty").value.trim();
  const item = tr.querySelector(".item").value.trim();
  const unit = tr.querySelector(".unit").value.trim();
  return qty !== "" && item !== "" && unit !== "";
}




tr.querySelectorAll("input,select").forEach(el=>{
  el.addEventListener("input", ()=>{
    calc(tr);
    autoExtendRow(tr);
  });
  el.addEventListener("keydown", e => nav(e,tr));
});


function autoExtendRow(tr){
  const allRows = [...rows.querySelectorAll("tr")];
  const isLastRow = tr === allRows[allRows.length - 1];

  if(isLastRow && isRowComplete(tr)){
    addRow();
  }
}
















/* ===============================
   GOLD AND SILVER RATE
================================ */

function calc(tr){
  const qty   = +tr.querySelector(".qty").value || 0;
  const unit  = +tr.querySelector(".unit").value || 0;
  const mark  = +tr.querySelector(".mark").value || 0;
  const metal = tr.querySelector(".metal").value;
  const gstP  = +gstRate.value || 0;

  const rate = metal === "Gold"
    ? +document.getElementById("goldRate").value
    : +document.getElementById("silverRate").value;

  const base  = qty * unit * rate;
  const after = base + (base * mark / 100);
  const gst   = after * gstP / 100;
  const total = after + gst;

  tr.querySelector(".after").value = after.toFixed(2);
  tr.querySelector(".gst").value   = gst.toFixed(2);
  tr.querySelector(".total").value = total.toFixed(2);
}

document.getElementById("goldRate").addEventListener("change", ()=>{
  document.querySelectorAll("#rows tr").forEach(tr=>calc(tr));
});

document.getElementById("silverRate").addEventListener("change", ()=>{
  document.querySelectorAll("#rows tr").forEach(tr=>calc(tr));
});










/* ===============================
   KEYBOARD NAV
================================ */
function nav(e,tr){
  if(e.key !== "Enter") return;
  e.preventDefault();

  const f = [...tr.querySelectorAll("input,select")];
  const i = f.indexOf(e.target);

  if(i === f.length - 1){
    const newTr = addRow();
    const firstInput = newTr.querySelector("input,select");
    if(firstInput) firstInput.focus();
  }else{
    f[i + 1].focus();
  }
}

/* ===============================
   NAVIGATION HELPER
================================ */
function navigateToOrders(){
  // Try to use loadPage if available (workspace context)
  if(typeof loadPage === 'function'){
    loadPage("../pages/orders.html");
    return;
  }
  
  // Try parent window
  if(window.parent && window.parent !== window && typeof window.parent.loadPage === 'function'){
    window.parent.loadPage("../pages/orders.html");
    return;
  }
  
  // Try top window
  if(window.top && window.top !== window && typeof window.top.loadPage === 'function'){
    window.top.loadPage("../pages/orders.html");
    return;
  }
  
  // Fallback: direct navigation
  const currentPath = window.location.pathname;
  if(currentPath.includes('/pages/')){
    window.location.href = "orders.html";
  } else {
    window.location.href = "/pages/orders.html";
  }
}

/* ===============================
   LOAD ORDER FOR EDITING
================================ */
function loadOrderForEdit(orderId){
  const orders = JSON.parse(localStorage.getItem("orders") || "[]");
  const order = orders.find(o => o.id === Number(orderId));
  
  if(!order){
    alert("Order not found");
    localStorage.removeItem("editOrderId");
    return;
  }

  // Update page title
  const title = document.querySelector('.order-title');
  if(title) title.textContent = "Edit Order";

  // Ensure customers are loaded first
  loadCustomers();
  
  // Function to set customer after dropdown is ready
  const setCustomer = (retryCount = 0) => {
    // Ensure customers are loaded
    loadCustomers();
    
    // Load customer data
    const customers = JSON.parse(localStorage.getItem("customers") || "[]");
    
    // Try to find customer by matching ID (handle both string and number)
    let customer = customers.find(c => String(c.id) === String(order.customerId));
    
    // If not found, try with number comparison
    if(!customer){
      customer = customers.find(c => Number(c.id) === Number(order.customerId));
    }
    
    if(!customer){
      if(retryCount < 3){
        // Retry after a short delay
        setTimeout(() => setCustomer(retryCount + 1), 100);
        return;
      }
      console.error("Customer not found for ID:", order.customerId);
      alert("Customer not found. Please select a customer manually.");
      return;
    }
    
    // Check if the option exists in dropdown
    const optionExists = Array.from(custName.options).some(opt => {
      return String(opt.value) === String(order.customerId) || 
             Number(opt.value) === Number(order.customerId);
    });
    
    if(optionExists){
      // Set customer in dropdown - try both string and number
      const customerIdStr = String(order.customerId);
      const customerIdNum = Number(order.customerId);
      
      // Find the correct option value
      let selectedValue = null;
      for(let opt of custName.options){
        if(opt.value === customerIdStr || Number(opt.value) === customerIdNum){
          selectedValue = opt.value;
          break;
        }
      }
      
      if(selectedValue !== null){
        // Set the value
        custName.value = selectedValue;
        
        // Manually trigger the change handler to populate fields
        // This ensures the fields are populated even if the event doesn't fire
        const selectedOption = custName.selectedOptions[0];
        if(selectedOption && selectedOption.dataset.data){
          try {
            const c = JSON.parse(selectedOption.dataset.data);
            currentBal.value = c.openingBalance || 0;
            relation.value = (c.relation || "") + " " + (c.relationName || "");
            station.value = c.station || "";
          } catch(e){
            console.error("Error parsing customer data:", e);
            // Fallback to direct customer object
            currentBal.value = customer.openingBalance || 0;
            relation.value = (customer.relation || "") + " " + (customer.relationName || "");
            station.value = customer.station || "";
          }
        } else {
          // Fallback: use customer object directly
          currentBal.value = customer.openingBalance || 0;
          relation.value = (customer.relation || "") + " " + (customer.relationName || "");
          station.value = customer.station || "";
        }
        
        // Also trigger the onchange event for any other listeners
        if(custName.onchange){
          try {
            custName.onchange();
          } catch(e){
            console.warn("Error triggering onchange:", e);
          }
        }
      } else {
        // Fallback: manually populate fields
        currentBal.value = customer.openingBalance || 0;
        relation.value = (customer.relation || "") + " " + (customer.relationName || "");
        station.value = customer.station || "";
      }
    } else {
      // If option doesn't exist, manually populate fields
      currentBal.value = customer.openingBalance || 0;
      relation.value = (customer.relation || "") + " " + (customer.relationName || "");
      station.value = customer.station || "";
      console.warn("Customer option not found in dropdown, but data loaded manually");
    }
  };
  
  // Wait for dropdown to be populated
  // Use multiple attempts to ensure it works
  setTimeout(() => {
    setCustomer();
  }, 150);

  // Load bill information
  billNo.value = order.billNo || "";
  billDate.value = order.date || billDate.value;
  if(document.getElementById("dueDate")){
    document.getElementById("dueDate").value = order.dueDate || "";
  }
  gstRate.value = order.gst || 3;

  // Clear existing rows
  rows.innerHTML = "";

  // Load order items
  if(order.items && order.items.length > 0){
    order.items.forEach(item => {
      const tr = addRow();
      
      // Populate item fields
      tr.querySelector(".qty").value = item.qty || 1;
      tr.querySelector(".item").value = item.item || "";
      tr.querySelector(".metal").value = item.metal || "Gold";
      tr.querySelector(".unit").value = item.purity || "";
      
      // Recalculate to populate computed fields
      calc(tr);
      
      // Load advance data if exists
      if(item.advance){
        tr.dataset.advData = JSON.stringify(item.advance);
        
        // Update button to show advance is set
        const btn = tr.querySelector('.adv-btn');
        if(btn){
          btn.textContent = 'Adv ✓';
          btn.style.background = '#d4edda';
          btn.style.color = '#155724';
        }
        
        // Update print display
        const advPrint = tr.querySelector('.adv-details-print');
        if(advPrint && item.advance.amount){
          const advDate = item.advance.date ? new Date(item.advance.date).toLocaleDateString() : '';
          advPrint.textContent = `Adv: ₹${parseFloat(item.advance.amount).toFixed(2)}${advDate ? ' on ' + advDate : ''}`;
        }
      }
    });
  } else {
    addRow();
  }

  // Store order ID for update
  const orderWindow = document.getElementById("order-window");
  if(orderWindow){
    orderWindow.dataset.orderId = orderId;
  }
}

/* ===============================
   SAVE ORDER
================================ */
function saveOrder(redirect = true){
  if(!custName.value){
    alert("Select customer");
    return false;
  }

  const orders = JSON.parse(localStorage.getItem("orders") || "[]");
  const editOrderId = localStorage.getItem("editOrderId");
  const isEdit = !!editOrderId;

  const order = {
    id: isEdit ? Number(editOrderId) : Date.now(),
    customerId: custName.value,
    billNo: billNo.value,
    date: billDate.value,
    dueDate: document.getElementById("dueDate")?.value || "",
    gst: +gstRate.value,
    items: [],
    status: isEdit ? orders.find(o => o.id === Number(editOrderId))?.status : undefined
  };

  rows.querySelectorAll("tr").forEach(tr=>{
    const item = tr.querySelector(".item").value.trim();
    if(!item) return; // skip empty rows

    const advData = tr.dataset.advData ? JSON.parse(tr.dataset.advData) : null;
    
    order.items.push({
      qty: tr.querySelector(".qty").value,
      item,
      metal: tr.querySelector(".metal").value,
      purity: tr.querySelector(".unit").value,
      total: tr.querySelector(".total").value,
      advance: advData // Include advance data
    });
  });

  if(order.items.length === 0){
    alert("Add at least one item");
    return false;
  }

  if(isEdit){
    // Update existing order
    const index = orders.findIndex(o => o.id === Number(editOrderId));
    if(index !== -1){
      // Preserve status if it exists
      if(orders[index].status){
        order.status = orders[index].status;
      }
      orders[index] = order;
      alert("Order updated successfully");
    } else {
      alert("Order not found");
      return false;
    }
    // Clear edit flag
    localStorage.removeItem("editOrderId");
  } else {
    // Add new order
    orders.push(order);
    alert("Order saved successfully");
  }

  localStorage.setItem("orders", JSON.stringify(orders));

  if(redirect){
    navigateToOrders();
  }

  return true;
}

/* ===============================
   SAVE & NEW
================================ */
function saveAndNew(){
  // Save the order and redirect to orders page
  if(saveOrder(true)){
    // Order saved successfully, navigation handled in saveOrder
  }
}

/* ===============================
   UTIL
================================ */
function cancelOrder(){
  if(confirm("Discard current order?")){
    navigateToOrders();
  }
}

function openCustomer(){
  loadPage("../pages/customer.html");
}

/* ===============================
   PRINT BILL FUNCTION
================================ */
function printBill(){
  // Calculate totals
  let subtotal = 0;
  let totalGst = 0;
  let totalAdvance = 0;
  
  rows.querySelectorAll("tr").forEach(tr => {
    const total = parseFloat(tr.querySelector(".total").value) || 0;
    const gst = parseFloat(tr.querySelector(".gst").value) || 0;
    subtotal += total - gst;
    totalGst += gst;
    
    // Get advance if exists
    if(tr.dataset.advData){
      const adv = JSON.parse(tr.dataset.advData);
      totalAdvance += parseFloat(adv.amount) || 0;
    }
  });
  
  const grandTotal = subtotal + totalGst;
  
  // Create bill summary element
  let summaryHTML = `
    <div class="bill-summary">
      <div class="summary-row">
        <span>Subtotal:</span>
        <span>₹${subtotal.toFixed(2)}</span>
      </div>
      <div class="summary-row">
        <span>GST (${gstRate.value}%):</span>
        <span>₹${totalGst.toFixed(2)}</span>
      </div>
  `;
  
  if(totalAdvance > 0){
    summaryHTML += `
      <div class="summary-row">
        <span>Advance Received:</span>
        <span>₹${totalAdvance.toFixed(2)}</span>
      </div>
    `;
  }
  
  summaryHTML += `
      <div class="summary-row">
        <span>Grand Total:</span>
        <span>₹${grandTotal.toFixed(2)}</span>
      </div>
      ${totalAdvance > 0 ? `
      <div class="summary-row">
        <span>Balance Amount:</span>
        <span>₹${(grandTotal - totalAdvance).toFixed(2)}</span>
      </div>
      ` : ''}
    </div>
  `;
  
  // Add summary before printing
  const existingSummary = document.querySelector('.bill-summary');
  if(existingSummary) existingSummary.remove();
  
  const orderDetails = document.querySelector('.order-details');
  orderDetails.insertAdjacentHTML('afterend', summaryHTML);
  
  // Trigger print
  window.print();
  
  // Remove summary after print (optional)
  setTimeout(() => {
    const summary = document.querySelector('.bill-summary');
    if(summary) summary.remove();
  }, 1000);
}

// Close modal on outside click
document.getElementById('advModal').addEventListener('click', function(e){
  if(e.target === this){
    closeAdvModal();
  }
});

// Initialize date in modal
document.addEventListener('DOMContentLoaded', function(){
  const advDate = document.getElementById('advPayDate');
  if(advDate && !advDate.value){
    advDate.value = new Date().toISOString().split("T")[0];
  }
});

</script>

</body>
</html>